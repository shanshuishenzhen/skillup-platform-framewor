# SkillUp Platform 云端系统操作指导手册

## 📋 目录

1. [系统概述](#1-系统概述)
2. [云端部署步骤](#2-云端部署步骤)
3. [环境配置](#3-环境配置)
4. [系统启动和管理](#4-系统启动和管理)
5. [监控和维护](#5-监控和维护)
6. [故障排除](#6-故障排除)
7. [安全建议](#7-安全建议)
8. [常用命令参考](#8-常用命令参考)

---

## 1. 系统概述

### 1.1 平台架构

SkillUp Platform 是一个基于 Next.js 的现代化在线学习平台，采用以下技术栈：

- **前端**: React 19.1.0 + Next.js 15.4.6 (App Router)
- **后端**: Next.js API Routes
- **数据库**: Supabase (PostgreSQL)
- **部署平台**: Vercel
- **文件存储**: 阿里云 OSS
- **缓存**: Redis
- **认证**: JWT + bcryptjs

### 1.2 核心功能模块

- 🎓 **学习功能**: 技能培训、在线考试、进度跟踪
- 🔐 **认证安全**: 用户认证、短信验证、人脸识别
- 📊 **管理监控**: 管理员后台、系统监控、数据分析
- 🛠️ **技术服务**: 文件存储、缓存服务、AI集成

---

## 2. 云端部署步骤

### 2.1 部署前准备

#### 系统要求
- Node.js >= 18.0.0
- npm >= 8.0.0
- Git 版本控制
- Vercel 账户

#### 环境检查
```bash
# 检查 Node.js 版本
node --version

# 检查 npm 版本
npm --version

# 检查项目构建
npm run build
```

### 2.2 Vercel 部署（推荐方式）

#### 方式一：使用 Vercel CLI

1. **安装 Vercel CLI**
   ```bash
   npm install -g vercel
   ```

2. **登录 Vercel**
   ```bash
   vercel login
   ```

3. **初始化项目**
   ```bash
   vercel
   ```
   - 选择创建新项目或链接现有项目
   - 确认项目设置和构建配置

4. **生产部署**
   ```bash
   vercel --prod
   ```

#### 方式二：Git 集成部署

1. **推送代码到 Git 仓库**
   ```bash
   git add .
   git commit -m "准备生产部署"
   git push origin main
   ```

2. **在 Vercel Dashboard 中**
   - 访问 [vercel.com](https://vercel.com)
   - 点击 "Import Project"
   - 选择 Git 仓库
   - 配置构建设置
   - 触发自动部署

### 2.3 部署配置文件

项目包含以下关键配置文件：

- **`vercel.json`**: Vercel 部署配置
- **`next.config.js`**: Next.js 构建配置
- **`.vercelignore`**: 部署时忽略的文件

---

## 3. 环境配置

### 3.1 必需的环境变量

在 Vercel Dashboard 或本地 `.env.local` 文件中配置：

```bash
# Supabase 数据库配置
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# 身份验证配置
JWT_SECRET=your_jwt_secret_key
NEXTAUTH_SECRET=your_nextauth_secret
NEXTAUTH_URL=https://your-domain.vercel.app

# 阿里云服务配置
ALIYUN_ACCESS_KEY_ID=your_access_key
ALIYUN_ACCESS_KEY_SECRET=your_secret_key
ALIYUN_OSS_BUCKET=your_bucket_name
ALIYUN_OSS_REGION=your_region
ALIYUN_SMS_SIGN_NAME=your_sms_sign_name
ALIYUN_SMS_TEMPLATE_CODE=your_sms_template_code

# 百度 AI 服务配置
BAIDU_API_KEY=your_baidu_api_key
BAIDU_SECRET_KEY=your_baidu_secret_key

# AI 服务配置
DEEPSEEK_API_KEY=your_deepseek_api_key
OPENAI_API_KEY=your_openai_api_key

# Redis 缓存配置
REDIS_URL=your_redis_url

# 监控配置
MONITORING_ENABLED=true
MONITORING_DASHBOARD_URL=http://localhost:8080/dashboard
```

### 3.2 环境变量配置步骤

#### 在 Vercel Dashboard 中配置

1. 进入项目设置页面
2. 选择 "Environment Variables" 选项卡
3. 添加所有必需的环境变量
4. 选择适当的环境（Production, Preview, Development）
5. 保存配置并重新部署

#### 本地开发环境配置

1. 复制 `.env.example` 为 `.env.local`
2. 填入实际的配置值
3. 确保 `.env.local` 已添加到 `.gitignore`

### 3.3 数据库迁移

项目使用 Supabase 数据库，迁移文件位于 `supabase/migrations/`：

```bash
# 应用数据库迁移
supabase db push

# 查看迁移状态
supabase migration list
```

关键迁移文件：
- `001_initial_schema.sql` - 基础用户和课程表
- `002_sms_verification.sql` - 短信验证码表
- `003_learning_progress.sql` - 学习进度表
- `add_face_verified_to_users.sql` - 人脸验证字段
- `create_face_auth_tables.sql` - 人脸认证表

---

## 4. 系统启动和管理

### 4.1 本地开发启动

#### 一键启动（推荐）

**Windows 用户：**
```bash
# 双击运行或命令行执行
start.bat
```

**Linux/Mac 用户：**
```bash
# 添加执行权限并运行
chmod +x start.sh
./start.sh
```

**使用 Node.js：**
```bash
node start.js
# 或者
npm run quick-start
```

#### 传统启动方式

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build

# 启动生产服务器
npm start
```

### 4.2 云端管理

#### Vercel 项目管理

1. **查看部署状态**
   - 访问 Vercel Dashboard
   - 查看部署历史和状态
   - 监控构建日志

2. **域名管理**
   - 配置自定义域名
   - 设置 SSL 证书
   - 管理 DNS 记录

3. **函数监控**
   - 查看 Serverless 函数执行情况
   - 监控 API 响应时间
   - 分析错误日志

### 4.3 数据库管理

#### Supabase 管理

1. **数据库监控**
   ```bash
   # 连接到数据库
   supabase db connect
   
   # 查看数据库状态
   supabase status
   ```

2. **备份和恢复**
   ```bash
   # 创建数据库备份
   supabase db dump > backup.sql
   
   # 恢复数据库
   supabase db reset
   ```

3. **用户管理**
   - 通过 Supabase Dashboard 管理用户
   - 配置认证策略
   - 设置行级安全策略

---

## 5. 监控和维护

### 5.1 系统监控

#### 关键监控指标

1. **性能指标**
   - 页面加载时间
   - API 响应时间
   - 数据库查询性能
   - CDN 缓存命中率

2. **可用性指标**
   - 系统正常运行时间
   - 错误率统计
   - 用户会话监控

3. **资源使用**
   - 函数执行时间
   - 数据库连接数
   - 存储空间使用
   - 带宽消耗

#### 监控工具

1. **Vercel Analytics**
   - 内置性能监控
   - 用户体验分析
   - 实时访问统计

2. **Supabase 监控**
   - 数据库性能监控
   - API 使用统计
   - 认证活动监控

3. **自定义监控**
   ```bash
   # 启用监控功能
   npm run monitoring:start
   
   # 查看监控报告
   npm run monitoring:report
   ```

### 5.2 日常维护任务

#### 每日检查
- [ ] 检查系统可用性
- [ ] 查看错误日志
- [ ] 监控性能指标
- [ ] 验证关键功能

#### 每周维护
- [ ] 更新依赖包
- [ ] 清理日志文件
- [ ] 检查安全漏洞
- [ ] 备份重要数据

#### 每月维护
- [ ] 性能优化分析
- [ ] 安全审计
- [ ] 容量规划评估
- [ ] 用户反馈分析

### 5.3 日志管理

#### 日志类型

1. **应用日志**
   - API 请求日志
   - 错误异常日志
   - 用户操作日志

2. **系统日志**
   - 部署日志
   - 构建日志
   - 函数执行日志

3. **安全日志**
   - 登录尝试记录
   - 权限访问日志
   - 异常行为检测

#### 日志查看命令

```bash
# 查看 Vercel 函数日志
vercel logs

# 查看实时日志
vercel logs --follow

# 查看特定函数日志
vercel logs --function=api/auth/login
```

---

## 6. 故障排除

### 6.1 常见问题诊断

#### 部署失败

**问题症状：**
- 构建过程中断
- 部署状态显示失败
- 函数无法正常启动

**诊断步骤：**

1. **检查构建日志**
   ```bash
   # 本地测试构建
   npm run build
   
   # 查看详细错误信息
   npm run build -- --debug
   ```

2. **验证环境变量**
   ```bash
   # 检查环境变量配置
   vercel env ls
   
   # 测试环境变量
   node -e "console.log(process.env.DATABASE_URL)"
   ```

3. **检查依赖问题**
   ```bash
   # 清理缓存
   npm cache clean --force
   
   # 重新安装依赖
   rm -rf node_modules package-lock.json
   npm install
   ```

#### 运行时错误

**问题症状：**
- API 请求失败
- 页面加载错误
- 数据库连接失败

**诊断步骤：**

1. **检查 API 状态**
   ```bash
   # 测试 API 端点
   curl -X GET https://your-domain.vercel.app/api/health
   
   # 检查数据库连接
   curl -X GET https://your-domain.vercel.app/api/db/status
   ```

2. **查看函数日志**
   ```bash
   # 查看最近的错误日志
   vercel logs --since=1h
   
   # 过滤错误日志
   vercel logs | grep ERROR
   ```

3. **验证外部服务**
   - 检查 Supabase 服务状态
   - 验证阿里云服务可用性
   - 测试 Redis 连接

#### 性能问题

**问题症状：**
- 页面加载缓慢
- API 响应超时
- 数据库查询慢

**优化措施：**

1. **启用缓存**
   ```javascript
   // 在 API 路由中添加缓存头
   export async function GET() {
     return new Response(data, {
       headers: {
         'Cache-Control': 'public, max-age=3600'
       }
     });
   }
   ```

2. **优化数据库查询**
   ```sql
   -- 添加索引
   CREATE INDEX idx_user_email ON users(email);
   
   -- 优化查询
   EXPLAIN ANALYZE SELECT * FROM courses WHERE category = 'tech';
   ```

3. **图片优化**
   ```javascript
   // 使用 Next.js Image 组件
   import Image from 'next/image';
   
   <Image
     src="/image.jpg"
     width={500}
     height={300}
     alt="Description"
     priority
   />
   ```

### 6.2 紧急故障处理

#### 系统完全不可用

1. **立即回滚**
   ```bash
   # 回滚到上一个稳定版本
   vercel rollback
   ```

2. **启用维护模式**
   - 在 Vercel 中设置维护页面
   - 通知用户系统维护

3. **紧急修复**
   ```bash
   # 创建热修复分支
   git checkout -b hotfix/critical-fix
   
   # 修复问题并快速部署
   git commit -m "Critical fix"
   git push origin hotfix/critical-fix
   vercel --prod
   ```

#### 数据库问题

1. **检查连接**
   ```bash
   # 测试数据库连接
   supabase db ping
   ```

2. **查看数据库状态**
   - 检查 Supabase Dashboard
   - 查看连接池状态
   - 监控查询性能

3. **紧急恢复**
   ```bash
   # 从备份恢复
   supabase db reset --from-backup
   ```

### 6.3 故障预防措施

#### 监控告警

1. **设置告警规则**
   - API 响应时间超过 5 秒
   - 错误率超过 5%
   - 数据库连接失败

2. **通知渠道**
   - 邮件通知
   - 短信告警
   - Slack 集成

#### 自动化测试

```bash
# 运行完整测试套件
npm run test

# 运行端到端测试
npm run test:e2e

# 性能测试
npm run test:performance
```

#### 健康检查

```javascript
// API 健康检查端点
export async function GET() {
  const checks = {
    database: await checkDatabase(),
    redis: await checkRedis(),
    external_apis: await checkExternalAPIs()
  };
  
  return Response.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    checks
  });
}
```

---

## 7. 安全建议

### 7.1 环境变量安全

#### 最佳实践

1. **敏感信息保护**
   - 不在代码中硬编码 API 密钥
   - 使用 Vercel 环境变量管理
   - 定期轮换密钥和令牌

2. **访问控制**
   ```bash
   # 限制环境变量访问权限
   vercel env add SECRET_KEY production
   ```

3. **审计日志**
   - 记录环境变量访问
   - 监控配置变更
   - 定期安全审计

### 7.2 API 安全

#### 认证和授权

1. **JWT 令牌管理**
   ```javascript
   // 设置合理的令牌过期时间
   const token = jwt.sign(
     { userId: user.id },
     process.env.JWT_SECRET,
     { expiresIn: '24h' }
   );
   ```

2. **API 速率限制**
   ```javascript
   // 实现速率限制
   const rateLimit = {
     windowMs: 15 * 60 * 1000, // 15 分钟
     max: 100 // 限制每个 IP 100 次请求
   };
   ```

3. **输入验证**
   ```javascript
   // 验证和清理用户输入
   import { z } from 'zod';
   
   const schema = z.object({
     email: z.string().email(),
     password: z.string().min(8)
   });
   ```

#### CORS 配置

```javascript
// next.config.js
module.exports = {
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          {
            key: 'Access-Control-Allow-Origin',
            value: 'https://your-domain.com'
          }
        ]
      }
    ];
  }
};
```

### 7.3 数据安全

#### 数据加密

1. **传输加密**
   - 强制使用 HTTPS
   - 配置 SSL/TLS 证书
   - 启用 HSTS 头

2. **存储加密**
   ```javascript
   // 敏感数据加密存储
   import bcrypt from 'bcryptjs';
   
   const hashedPassword = await bcrypt.hash(password, 12);
   ```

3. **数据脱敏**
   ```javascript
   // API 响应中隐藏敏感信息
   const safeUser = {
     id: user.id,
     email: user.email.replace(/(.{2}).*(@.*)/, '$1***$2'),
     name: user.name
   };
   ```

#### 数据库安全

1. **行级安全策略**
   ```sql
   -- Supabase RLS 策略
   CREATE POLICY "Users can only see own data" ON users
   FOR SELECT USING (auth.uid() = id);
   ```

2. **SQL 注入防护**
   ```javascript
   // 使用参数化查询
   const { data } = await supabase
     .from('users')
     .select('*')
     .eq('email', email); // 自动转义
   ```

### 7.4 监控和审计

#### 安全监控

1. **异常检测**
   - 监控异常登录尝试
   - 检测 API 滥用
   - 识别可疑用户行为

2. **日志审计**
   ```javascript
   // 记录安全相关事件
   const auditLog = {
     userId: user.id,
     action: 'login_attempt',
     ip: request.ip,
     userAgent: request.headers['user-agent'],
     timestamp: new Date().toISOString(),
     success: true
   };
   ```

#### 合规性

1. **数据保护**
   - 实施 GDPR 合规措施
   - 提供数据导出功能
   - 支持数据删除请求

2. **隐私政策**
   - 明确数据收集范围
   - 说明数据使用目的
   - 提供用户控制选项

---

## 8. 常用命令参考

### 8.1 部署命令

```bash
# Vercel 部署
vercel                    # 预览部署
vercel --prod            # 生产部署
vercel rollback          # 回滚部署
vercel logs              # 查看日志
vercel env ls            # 列出环境变量
vercel domains ls        # 列出域名

# Git 操作
git add .                # 添加所有更改
git commit -m "message"  # 提交更改
git push origin main     # 推送到远程仓库
git pull origin main     # 拉取最新代码
```

### 8.2 开发命令

```bash
# 项目管理
npm install              # 安装依赖
npm run dev              # 启动开发服务器
npm run build            # 构建生产版本
npm run start            # 启动生产服务器
npm run lint             # 代码检查
npm run test             # 运行测试

# 数据库操作
supabase start           # 启动本地 Supabase
supabase stop            # 停止本地 Supabase
supabase db reset        # 重置数据库
supabase db push         # 推送迁移
supabase gen types       # 生成类型定义
```

### 8.3 监控命令

```bash
# 系统监控
vercel logs --follow     # 实时日志
vercel logs --since=1h   # 最近1小时日志
vercel logs --function=api/auth  # 特定函数日志

# 性能分析
npm run analyze          # 构建分析
npm run lighthouse       # 性能测试
npm run test:load        # 负载测试
```

### 8.4 故障排除命令

```bash
# 清理和重置
npm cache clean --force  # 清理 npm 缓存
rm -rf node_modules      # 删除依赖目录
rm package-lock.json     # 删除锁定文件
npm install              # 重新安装依赖

# 调试
node --inspect start.js  # 调试模式启动
npm run dev -- --debug   # 调试模式开发
vercel dev --debug       # 本地调试 Vercel 函数
```

---

## 📞 技术支持

### 联系方式

- **文档**: 查看项目 `docs/` 目录
- **问题反馈**: 提交 GitHub Issue
- **紧急支持**: 联系系统管理员

### 有用资源

- [Vercel 官方文档](https://vercel.com/docs)
- [Next.js 部署指南](https://nextjs.org/docs/deployment)
- [Supabase 文档](https://supabase.com/docs)
- [项目 README](../README.md)

---

**🎉 祝您使用愉快！**

> 本指导手册涵盖了 SkillUp Platform 云端系统的完整操作流程。如有疑问，请参考相关文档或联系技术支持团队。