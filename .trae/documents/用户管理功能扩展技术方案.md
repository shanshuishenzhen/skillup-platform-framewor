# 用户管理功能扩展技术方案

## 1. 概述

本文档详细描述了基于用户群体特点（20%自主注册，80%批量导入）的用户管理功能扩展技术方案，包括数据库扩展、API接口设计、批量操作优化和系统间数据同步机制。

## 2. 数据库扩展方案

### 2.1 用户表结构扩展

#### 2.1.1 新增字段定义

```sql
-- 创建用户表扩展迁移脚本
-- 文件：supabase/migrations/004_user_management_extension.sql

-- 身份信息扩展
ALTER TABLE users ADD COLUMN IF NOT EXISTS employee_id VARCHAR(50) UNIQUE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS department VARCHAR(100);
ALTER TABLE users ADD COLUMN IF NOT EXISTS position VARCHAR(100);
ALTER TABLE users ADD COLUMN IF NOT EXISTS organization VARCHAR(100);

-- 学习相关字段
ALTER TABLE users ADD COLUMN IF NOT EXISTS learning_level VARCHAR(20) DEFAULT 'beginner' 
  CHECK (learning_level IN ('beginner', 'intermediate', 'advanced', 'expert'));
ALTER TABLE users ADD COLUMN IF NOT EXISTS learning_progress JSONB DEFAULT '{}';
ALTER TABLE users ADD COLUMN IF NOT EXISTS learning_hours INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN IF NOT EXISTS last_learning_time TIMESTAMP WITH TIME ZONE;

-- 考试相关字段
ALTER TABLE users ADD COLUMN IF NOT EXISTS exam_permissions TEXT[] DEFAULT '{}';
ALTER TABLE users ADD COLUMN IF NOT EXISTS exam_history JSONB DEFAULT '{}';
ALTER TABLE users ADD COLUMN IF NOT EXISTS certification_status VARCHAR(20) DEFAULT 'none'
  CHECK (certification_status IN ('none', 'pending', 'certified', 'expired'));
ALTER TABLE users ADD COLUMN IF NOT EXISTS certification_date TIMESTAMP WITH TIME ZONE;

-- 批量导入管理字段
ALTER TABLE users ADD COLUMN IF NOT EXISTS import_batch_id VARCHAR(50);
ALTER TABLE users ADD COLUMN IF NOT EXISTS import_source VARCHAR(20) DEFAULT 'manual'
  CHECK (import_source IN ('manual', 'excel_import', 'api_import', 'sync'));
ALTER TABLE users ADD COLUMN IF NOT EXISTS import_date TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- 同步状态字段
ALTER TABLE users ADD COLUMN IF NOT EXISTS sync_status VARCHAR(20) DEFAULT 'synced'
  CHECK (sync_status IN ('synced', 'pending_sync', 'sync_failed', 'sync_disabled'));
ALTER TABLE users ADD COLUMN IF NOT EXISTS last_sync_time TIMESTAMP WITH TIME ZONE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS sync_error_message TEXT;

-- 创建索引优化查询性能
CREATE INDEX IF NOT EXISTS idx_users_employee_id ON users(employee_id) WHERE employee_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_users_department ON users(department) WHERE department IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_users_organization ON users(organization) WHERE organization IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_users_import_batch ON users(import_batch_id) WHERE import_batch_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_users_sync_status ON users(sync_status);
CREATE INDEX IF NOT EXISTS idx_users_learning_level ON users(learning_level);
CREATE INDEX IF NOT EXISTS idx_users_certification_status ON users(certification_status);

-- 创建复合索引
CREATE INDEX IF NOT EXISTS idx_users_org_dept ON users(organization, department) WHERE organization IS NOT NULL AND department IS NOT NULL;
```

#### 2.1.2 数据迁移脚本

```sql
-- 为现有用户设置默认值
UPDATE users SET 
  import_source = 'manual',
  sync_status = 'synced',
  learning_level = 'beginner',
  certification_status = 'none'
WHERE import_source IS NULL;

-- 为管理员用户设置特殊权限
UPDATE users SET 
  exam_permissions = ARRAY['all_exams', 'manage_users', 'view_reports']
WHERE user_type = 'ADMIN' OR user_type = 'SUPER_ADMIN';
```

### 2.2 相关表创建

#### 2.2.1 批量导入记录表

```sql
-- 批量导入记录表
CREATE TABLE IF NOT EXISTS user_import_batches (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  batch_id VARCHAR(50) UNIQUE NOT NULL,
  file_name VARCHAR(255),
  total_records INTEGER NOT NULL,
  success_records INTEGER DEFAULT 0,
  failed_records INTEGER DEFAULT 0,
  import_status VARCHAR(20) DEFAULT 'processing' 
    CHECK (import_status IN ('processing', 'completed', 'failed', 'cancelled')),
  error_summary JSONB DEFAULT '{}',
  imported_by UUID REFERENCES users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  completed_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_import_batches_status ON user_import_batches(import_status);
CREATE INDEX idx_import_batches_date ON user_import_batches(created_at DESC);
```

#### 2.2.2 用户同步日志表

```sql
-- 用户同步日志表
CREATE TABLE IF NOT EXISTS user_sync_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  sync_type VARCHAR(20) NOT NULL CHECK (sync_type IN ('user_data', 'learning_progress', 'exam_results')),
  sync_direction VARCHAR(10) NOT NULL CHECK (sync_direction IN ('upload', 'download')),
  sync_status VARCHAR(20) NOT NULL CHECK (sync_status IN ('success', 'failed', 'partial')),
  data_snapshot JSONB,
  error_message TEXT,
  sync_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  target_system VARCHAR(50)
);

CREATE INDEX idx_sync_logs_user ON user_sync_logs(user_id);
CREATE INDEX idx_sync_logs_status ON user_sync_logs(sync_status);
CREATE INDEX idx_sync_logs_time ON user_sync_logs(sync_time DESC);
```

## 3. API接口扩展

### 3.1 批量用户管理接口

#### 3.1.1 批量导入接口

```typescript
// POST /api/admin/users/batch-import
interface BatchImportRequest {
  file: File; // CSV文件
  options: {
    skipDuplicates: boolean;
    updateExisting: boolean;
    defaultPassword?: string;
    batchId?: string;
  };
}

interface BatchImportResponse {
  batchId: string;
  status: 'processing' | 'completed' | 'failed';
  summary: {
    totalRecords: number;
    successRecords: number;
    failedRecords: number;
    duplicateRecords: number;
  };
  errors: Array<{
    row: number;
    field: string;
    message: string;
    data: any;
  }>;
}
```

#### 3.1.2 批量操作接口

```typescript
// POST /api/admin/users/batch-operations
interface BatchOperationRequest {
  operation: 'activate' | 'deactivate' | 'delete' | 'update_permissions' | 'sync';
  userIds?: string[];
  filters?: {
    department?: string;
    organization?: string;
    importBatchId?: string;
    syncStatus?: string;
  };
  data?: any; // 操作相关数据
}

interface BatchOperationResponse {
  operationId: string;
  affectedUsers: number;
  status: 'processing' | 'completed' | 'failed';
  results: Array<{
    userId: string;
    status: 'success' | 'failed';
    message?: string;
  }>;
}
```

### 3.2 用户查询接口扩展

```typescript
// GET /api/admin/users
interface UserQueryParams {
  page?: number;
  limit?: number;
  search?: string;
  department?: string;
  organization?: string;
  learningLevel?: string;
  certificationStatus?: string;
  syncStatus?: string;
  importSource?: string;
  importBatchId?: string;
  sortBy?: 'name' | 'created_at' | 'last_learning_time' | 'certification_date';
  sortOrder?: 'asc' | 'desc';
}

interface UserListResponse {
  users: ExtendedUser[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    totalPages: number;
  };
  statistics: {
    totalUsers: number;
    activeUsers: number;
    byDepartment: Record<string, number>;
    byLearningLevel: Record<string, number>;
    byCertificationStatus: Record<string, number>;
  };
}

interface ExtendedUser {
  id: string;
  name: string;
  phone: string;
  email?: string;
  employeeId?: string;
  department?: string;
  position?: string;
  organization?: string;
  learningLevel: string;
  learningProgress: Record<string, any>;
  learningHours: number;
  examPermissions: string[];
  certificationStatus: string;
  certificationDate?: string;
  importBatchId?: string;
  importSource: string;
  syncStatus: string;
  lastSyncTime?: string;
  createdAt: string;
  updatedAt: string;
}
```

### 3.3 数据同步接口

```typescript
// POST /api/sync/users
interface UserSyncRequest {
  batchId: string;
  users: UserSyncData[];
  syncType: 'full' | 'incremental';
  targetSystem: string;
}

interface UserSyncData {
  id: string;
  name: string;
  phone: string;
  employeeId?: string;
  department?: string;
  learningLevel: string;
  examPermissions: string[];
  learningProgress: Record<string, any>;
  lastModified: string;
}

// POST /api/sync/exam-results
interface ExamResultSyncRequest {
  results: ExamResultData[];
  examSession: string;
  syncTime: string;
}

interface ExamResultData {
  userId: string;
  examId: string;
  score: number;
  passed: boolean;
  completedAt: string;
  answers: Record<string, any>;
  certificationEarned?: string;
}
```

## 4. 业务逻辑实现

### 4.1 批量导入服务

```typescript
// src/services/userBatchImportService.ts
export class UserBatchImportService {
  /**
   * 批量导入用户
   * @param file CSV文件
   * @param options 导入选项
   * @param importedBy 导入操作者ID
   * @returns 导入结果
   */
  async batchImportUsers(
    file: File, 
    options: BatchImportOptions, 
    importedBy: string
  ): Promise<BatchImportResult> {
    const batchId = options.batchId || generateBatchId();
    
    try {
      // 1. 解析CSV文件
      const userData = await this.parseCSVFile(file);
      
      // 2. 创建导入批次记录
      await this.createImportBatch(batchId, file.name, userData.length, importedBy);
      
      // 3. 数据验证和清洗
      const validationResult = await this.validateUserData(userData);
      
      // 4. 处理重复用户
      const deduplicationResult = await this.handleDuplicateUsers(
        validationResult.validData, 
        options
      );
      
      // 5. 批量插入数据库
      const importResult = await this.insertUsersInBatch(
        deduplicationResult.processedData,
        batchId
      );
      
      // 6. 更新批次状态
      await this.updateImportBatchStatus(batchId, importResult);
      
      // 7. 生成导入报告
      return this.generateImportReport(batchId, importResult, validationResult.errors);
      
    } catch (error) {
      await this.handleImportError(batchId, error);
      throw error;
    }
  }
  
  /**
   * 验证用户数据
   * @param userData 用户数据数组
   * @returns 验证结果
   */
  private async validateUserData(userData: any[]): Promise<ValidationResult> {
    const errors: ValidationError[] = [];
    const validData: any[] = [];
    
    for (let i = 0; i < userData.length; i++) {
      const user = userData[i];
      const rowErrors: ValidationError[] = [];
      
      // 必填字段验证
      if (!user.name?.trim()) {
        rowErrors.push({ row: i + 1, field: 'name', message: '姓名不能为空' });
      }
      
      if (!user.phone?.trim()) {
        rowErrors.push({ row: i + 1, field: 'phone', message: '手机号不能为空' });
      } else if (!this.isValidPhone(user.phone)) {
        rowErrors.push({ row: i + 1, field: 'phone', message: '手机号格式不正确' });
      }
      
      // 邮箱格式验证
      if (user.email && !this.isValidEmail(user.email)) {
        rowErrors.push({ row: i + 1, field: 'email', message: '邮箱格式不正确' });
      }
      
      // 学习等级验证
      if (user.learning_level && !['beginner', 'intermediate', 'advanced', 'expert'].includes(user.learning_level)) {
        rowErrors.push({ row: i + 1, field: 'learning_level', message: '学习等级值无效' });
      }
      
      // 角色验证
      if (user.role && !['USER', 'ADMIN', 'SUPER_ADMIN'].includes(user.role)) {
        rowErrors.push({ row: i + 1, field: 'role', message: '用户角色值无效' });
      }
      
      if (rowErrors.length === 0) {
        validData.push(this.normalizeUserData(user));
      } else {
        errors.push(...rowErrors);
      }
    }
    
    return { validData, errors };
  }
  
  /**
   * 处理重复用户
   * @param userData 验证后的用户数据
   * @param options 导入选项
   * @returns 处理结果
   */
  private async handleDuplicateUsers(
    userData: any[], 
    options: BatchImportOptions
  ): Promise<DeduplicationResult> {
    const processedData: any[] = [];
    const duplicates: any[] = [];
    
    for (const user of userData) {
      // 检查手机号重复
      const existingUser = await this.findUserByPhone(user.phone);
      
      if (existingUser) {
        if (options.skipDuplicates) {
          duplicates.push({ user, reason: '手机号已存在，跳过导入' });
          continue;
        } else if (options.updateExisting) {
          // 更新现有用户信息
          user.id = existingUser.id;
          user._isUpdate = true;
        } else {
          duplicates.push({ user, reason: '手机号已存在，需要处理' });
          continue;
        }
      }
      
      // 检查工号重复
      if (user.employee_id) {
        const existingByEmployeeId = await this.findUserByEmployeeId(user.employee_id);
        if (existingByEmployeeId && existingByEmployeeId.id !== user.id) {
          duplicates.push({ user, reason: '工号已存在' });
          continue;
        }
      }
      
      processedData.push(user);
    }
    
    return { processedData, duplicates };
  }
  
  /**
   * 批量插入用户到数据库
   * @param userData 处理后的用户数据
   * @param batchId 批次ID
   * @returns 插入结果
   */
  private async insertUsersInBatch(
    userData: any[], 
    batchId: string
  ): Promise<BatchInsertResult> {
    const supabase = createClient();
    const results: any[] = [];
    let successCount = 0;
    let failedCount = 0;
    
    // 使用事务处理批量插入
    const { data, error } = await supabase.rpc('batch_insert_users', {
      users_data: userData.map(user => ({
        ...user,
        import_batch_id: batchId,
        import_source: 'excel_import',
        password_hash: user.password ? await this.hashPassword(user.password) : null
      }))
    });
    
    if (error) {
      throw new Error(`批量插入失败: ${error.message}`);
    }
    
    return {
      successCount: data.success_count,
      failedCount: data.failed_count,
      results: data.results
    };
  }
}
```

### 4.2 数据同步服务

```typescript
// src/services/userSyncService.ts
export class UserSyncService {
  /**
   * 同步用户数据到考试系统
   * @param userIds 用户ID数组
   * @param targetSystem 目标系统
   * @returns 同步结果
   */
  async syncUsersToExamSystem(
    userIds: string[], 
    targetSystem: string
  ): Promise<SyncResult> {
    try {
      // 1. 获取用户数据
      const users = await this.getUsersForSync(userIds);
      
      // 2. 转换数据格式
      const syncData = users.map(user => this.transformUserForSync(user));
      
      // 3. 发送到目标系统
      const syncResult = await this.sendToTargetSystem(syncData, targetSystem);
      
      // 4. 更新同步状态
      await this.updateSyncStatus(userIds, syncResult);
      
      // 5. 记录同步日志
      await this.logSyncOperation(userIds, syncResult, targetSystem);
      
      return syncResult;
      
    } catch (error) {
      await this.handleSyncError(userIds, error, targetSystem);
      throw error;
    }
  }
  
  /**
   * 从考试系统接收考试结果
   * @param examResults 考试结果数据
   * @returns 处理结果
   */
  async receiveExamResults(examResults: ExamResultData[]): Promise<ProcessResult> {
    const results: any[] = [];
    
    for (const result of examResults) {
      try {
        // 1. 验证用户存在
        const user = await this.findUserById(result.userId);
        if (!user) {
          results.push({ userId: result.userId, status: 'failed', message: '用户不存在' });
          continue;
        }
        
        // 2. 更新考试历史
        await this.updateUserExamHistory(result.userId, result);
        
        // 3. 更新认证状态
        if (result.passed && result.certificationEarned) {
          await this.updateCertificationStatus(result.userId, result.certificationEarned);
        }
        
        // 4. 触发学习路径推荐
        await this.triggerLearningPathRecommendation(result.userId, result);
        
        results.push({ userId: result.userId, status: 'success' });
        
      } catch (error) {
        results.push({ 
          userId: result.userId, 
          status: 'failed', 
          message: error.message 
        });
      }
    }
    
    return { results };
  }
}
```

## 5. 前端组件扩展

### 5.1 批量导入组件

```typescript
// src/components/admin/UserBatchImport.tsx
export function UserBatchImport() {
  const [file, setFile] = useState<File | null>(null);
  const [importOptions, setImportOptions] = useState<BatchImportOptions>({
    skipDuplicates: true,
    updateExisting: false
  });
  const [importStatus, setImportStatus] = useState<'idle' | 'uploading' | 'processing' | 'completed' | 'error'>('idle');
  const [importResult, setImportResult] = useState<BatchImportResult | null>(null);
  
  const handleFileUpload = async () => {
    if (!file) return;
    
    setImportStatus('uploading');
    
    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('options', JSON.stringify(importOptions));
      
      const response = await fetch('/api/admin/users/batch-import', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (result.status === 'processing') {
        setImportStatus('processing');
        // 轮询检查导入状态
        await this.pollImportStatus(result.batchId);
      } else {
        setImportResult(result);
        setImportStatus('completed');
      }
      
    } catch (error) {
      setImportStatus('error');
      console.error('导入失败:', error);
    }
  };
  
  return (
    <div className="space-y-6">
      <div className="bg-white p-6 rounded-lg shadow">
        <h3 className="text-lg font-medium mb-4">批量导入用户</h3>
        
        {/* 文件上传区域 */}
        <div className="mb-4">
          <label className="block text-sm font-medium mb-2">选择CSV文件</label>
          <input
            type="file"
            accept=".csv"
            onChange={(e) => setFile(e.target.files?.[0] || null)}
            className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
          />
        </div>
        
        {/* 导入选项 */}
        <div className="mb-4 space-y-2">
          <label className="flex items-center">
            <input
              type="checkbox"
              checked={importOptions.skipDuplicates}
              onChange={(e) => setImportOptions(prev => ({ ...prev, skipDuplicates: e.target.checked }))}
              className="mr-2"
            />
            跳过重复用户
          </label>
          <label className="flex items-center">
            <input
              type="checkbox"
              checked={importOptions.updateExisting}
              onChange={(e) => setImportOptions(prev => ({ ...prev, updateExisting: e.target.checked }))}
              className="mr-2"
            />
            更新现有用户信息
          </label>
        </div>
        
        {/* 导入按钮 */}
        <button
          onClick={handleFileUpload}
          disabled={!file || importStatus === 'uploading' || importStatus === 'processing'}
          className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50"
        >
          {importStatus === 'uploading' ? '上传中...' : 
           importStatus === 'processing' ? '处理中...' : '开始导入'}
        </button>
      </div>
      
      {/* 导入结果显示 */}
      {importResult && (
        <ImportResultDisplay result={importResult} />
      )}
    </div>
  );
}
```

## 6. 部署和监控

### 6.1 数据库迁移部署

```bash
# 执行数据库迁移
npm run db:migrate

# 验证迁移结果
npm run db:verify

# 如需回滚
npm run db:rollback
```

### 6.2 性能监控

- 批量导入操作性能监控
- 数据同步延迟监控
- 用户查询响应时间监控
- 数据库连接池状态监控

### 6.3 错误处理和日志

- 批量操作错误详细记录
- 数据同步失败自动重试机制
- 用户操作审计日志
- 系统性能指标收集

## 7. 测试方案

### 7.1 单元测试

- 数据验证逻辑测试
- 批量导入服务测试
- 数据同步服务测试

### 7.2 集成测试

- 完整批量导入流程测试
- 系统间数据同步测试
- API接口集成测试

### 7.3 性能测试

- 大批量用户导入性能测试
- 并发用户查询性能测试
- 数据同步性能测试

## 8. 风险控制

### 8.1 数据安全

- 批量导入数据加密传输
- 敏感信息脱敏处理
- 操作权限严格控制

### 8.2 系统稳定性

- 批量操作限流机制
- 数据库连接池管理
- 异常情况自动恢复

### 8.3 业务连续性

- 导入失败回滚机制
- 数据备份和恢复
- 系统降级方案