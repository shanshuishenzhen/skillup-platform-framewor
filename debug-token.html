<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokenè°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Tokenè°ƒè¯•å·¥å…·</h1>
        <p>ç”¨äºæ£€æŸ¥å’Œä¿®å¤ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤ºé—®é¢˜</p>
        
        <div id="tokenStatus" class="section"></div>
        
        <div class="section">
            <h3>ğŸ› ï¸ æ“ä½œå·¥å…·</h3>
            <button onclick="checkToken()">æ£€æŸ¥TokençŠ¶æ€</button>
            <button onclick="testAPI()">æµ‹è¯•APIè°ƒç”¨</button>
            <button onclick="clearStorage()">æ¸…é™¤å­˜å‚¨</button>
            <button onclick="adminLogin()">ç®¡ç†å‘˜ç™»å½•</button>
        </div>
        
        <div id="results" class="section" style="display: none;">
            <h3>ğŸ“Š æ£€æŸ¥ç»“æœ</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        // æ£€æŸ¥TokençŠ¶æ€
        function checkToken() {
            const results = {
                localStorage: {},
                tokenAnalysis: null,
                userInfo: null
            };
            
            // æ£€æŸ¥localStorageä¸­çš„æ‰€æœ‰ç›¸å…³é¡¹
            const keys = ['token', 'user', 'authToken', 'adminToken', 'userInfo', 'adminInfo'];
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                results.localStorage[key] = value ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨';
                if (value && key === 'token') {
                    try {
                        // è§£æJWT token
                        const payload = JSON.parse(atob(value.split('.')[1]));
                        results.tokenAnalysis = {
                            userId: payload.userId,
                            phone: payload.phone,
                            role: payload.role,
                            type: payload.type,
                            isExpired: payload.exp * 1000 < Date.now(),
                            expiresAt: new Date(payload.exp * 1000).toLocaleString()
                        };
                    } catch (e) {
                        results.tokenAnalysis = { error: 'Tokenè§£æå¤±è´¥: ' + e.message };
                    }
                }
                if (value && (key === 'user' || key === 'userInfo' || key === 'adminInfo')) {
                    try {
                        results.userInfo = JSON.parse(value);
                    } catch (e) {
                        results.userInfo = { error: 'ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥: ' + e.message };
                    }
                }
            });
            
            displayResults(results);
        }
        
        // æµ‹è¯•APIè°ƒç”¨
        async function testAPI() {
            const token = localStorage.getItem('token');
            if (!token) {
                displayResults({ error: 'æ²¡æœ‰æ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•' });
                return;
            }
            
            try {
                // æµ‹è¯•æƒé™æ£€æŸ¥API
                const permissionResponse = await fetch('/api/admin/check-permission', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // æµ‹è¯•ç”¨æˆ·åˆ—è¡¨API
                const usersResponse = await fetch('/api/admin/users?page=1&limit=10', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const results = {
                    permissionCheck: {
                        status: permissionResponse.status,
                        ok: permissionResponse.ok,
                        data: permissionResponse.ok ? await permissionResponse.json() : await permissionResponse.text()
                    },
                    usersList: {
                        status: usersResponse.status,
                        ok: usersResponse.ok,
                        data: usersResponse.ok ? await usersResponse.json() : await usersResponse.text()
                    }
                };
                
                displayResults(results);
            } catch (error) {
                displayResults({ error: 'APIæµ‹è¯•å¤±è´¥: ' + error.message });
            }
        }
        
        // æ¸…é™¤å­˜å‚¨
        function clearStorage() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰localStorageæ•°æ®å—ï¼Ÿ')) {
                localStorage.clear();
                displayResults({ message: 'localStorageå·²æ¸…é™¤ï¼Œè¯·é‡æ–°ç™»å½•' });
            }
        }
        
        // ç®¡ç†å‘˜ç™»å½•
        async function adminLogin() {
            const phone = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜æ‰‹æœºå·:', '13823738278');
            const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç :', '123456');
            
            if (!phone || !password) return;
            
            try {
                const response = await fetch('/api/admin/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone, password })
                });
                
                const result = await response.json();
                
                if (result.success && result.token) {
                    // å­˜å‚¨tokenå’Œç”¨æˆ·ä¿¡æ¯
                    localStorage.setItem('token', result.token);
                    localStorage.setItem('user', JSON.stringify(result.user));
                    
                    displayResults({ 
                        message: 'ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼Tokenå·²ä¿å­˜åˆ°localStorage',
                        loginResult: result
                    });
                    
                    // è‡ªåŠ¨è·³è½¬åˆ°ç®¡ç†é¡µé¢
                    setTimeout(() => {
                        window.location.href = '/admin';
                    }, 2000);
                } else {
                    displayResults({ error: 'ç™»å½•å¤±è´¥: ' + (result.error || result.message) });
                }
            } catch (error) {
                displayResults({ error: 'ç™»å½•è¯·æ±‚å¤±è´¥: ' + error.message });
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const contentDiv = document.getElementById('resultContent');
            
            resultsDiv.style.display = 'block';
            contentDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
            
            // æ›´æ–°tokençŠ¶æ€æ˜¾ç¤º
            updateTokenStatus();
        }
        
        // æ›´æ–°tokençŠ¶æ€æ˜¾ç¤º
        function updateTokenStatus() {
            const statusDiv = document.getElementById('tokenStatus');
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (!token) {
                statusDiv.className = 'section error';
                statusDiv.innerHTML = '<h3>âŒ TokençŠ¶æ€</h3><p>æœªæ‰¾åˆ°tokenï¼Œç”¨æˆ·æœªç™»å½•</p>';
            } else {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const isExpired = payload.exp * 1000 < Date.now();
                    
                    if (isExpired) {
                        statusDiv.className = 'section warning';
                        statusDiv.innerHTML = '<h3>âš ï¸ TokençŠ¶æ€</h3><p>Tokenå·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•</p>';
                    } else {
                        statusDiv.className = 'section success';
                        statusDiv.innerHTML = `<h3>âœ… TokençŠ¶æ€</h3><p>Tokenæœ‰æ•ˆï¼Œè§’è‰²: ${payload.role}, è¿‡æœŸæ—¶é—´: ${new Date(payload.exp * 1000).toLocaleString()}</p>`;
                    }
                } catch (e) {
                    statusDiv.className = 'section error';
                    statusDiv.innerHTML = '<h3>âŒ TokençŠ¶æ€</h3><p>Tokenæ ¼å¼æ— æ•ˆ</p>';
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.onload = function() {
            updateTokenStatus();
        };
    </script>
</body>
</html>