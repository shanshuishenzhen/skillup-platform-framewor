# OAç³»ç»Ÿæ¨¡å—åŒ–ç§»æ¤æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›å°†OAç³»ç»Ÿä½œä¸ºå­æ¨¡å—é›†æˆåˆ°å…¶ä»–ç½‘é¡µç³»ç»Ÿçš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ¥å£æ ‡å‡†åŒ–ã€æ•°æ®å­—å…¸ã€é…ç½®ç®¡ç†å’Œç§»æ¤æ­¥éª¤ã€‚

## ğŸ—ï¸ æ¨¡å—åŒ–æ¶æ„è®¾è®¡

### 1. æ ¸å¿ƒæ¨¡å—åˆ’åˆ†

```
OA-Module/
â”œâ”€â”€ ğŸ“ core/                    # æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ auth/                   # è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ user/                   # ç”¨æˆ·ç®¡ç†
â”‚   â””â”€â”€ permission/             # æƒé™æ§åˆ¶
â”œâ”€â”€ ğŸ“ business/                # ä¸šåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ project/                # é¡¹ç›®ç®¡ç†
â”‚   â”œâ”€â”€ task/                   # ä»»åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ file/                   # æ–‡ä»¶ç®¡ç†
â”‚   â””â”€â”€ message/                # æ¶ˆæ¯é€šè®¯
â”œâ”€â”€ ğŸ“ shared/                  # å…±äº«æ¨¡å—
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ constants/              # å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ types/                  # ç±»å‹å®šä¹‰
â””â”€â”€ ğŸ“ integration/             # é›†æˆæ¨¡å—
    â”œâ”€â”€ api/                    # APIé€‚é…å™¨
    â”œâ”€â”€ config/                 # é…ç½®ç®¡ç†
    â””â”€â”€ hooks/                  # ç”Ÿå‘½å‘¨æœŸé’©å­
```

### 2. æ¨¡å—ä¾èµ–å…³ç³»

```mermaid
graph TD
    A[ä¸»ç³»ç»Ÿ] --> B[OAé›†æˆæ¨¡å—]
    B --> C[æ ¸å¿ƒæ¨¡å—]
    B --> D[ä¸šåŠ¡æ¨¡å—]
    B --> E[å…±äº«æ¨¡å—]
    
    C --> F[è®¤è¯é€‚é…å™¨]
    C --> G[ç”¨æˆ·é€‚é…å™¨]
    C --> H[æƒé™é€‚é…å™¨]
    
    D --> I[é¡¹ç›®ç®¡ç†]
    D --> J[æ–‡ä»¶ç®¡ç†]
    D --> K[æ¶ˆæ¯é€šè®¯]
    
    E --> L[å·¥å…·åº“]
    E --> M[å¸¸é‡å­—å…¸]
```

## ğŸ“š æ¥å£æ ‡å‡†åŒ–æ–‡æ¡£

### 1. APIæ¥å£è§„èŒƒ

#### ç»Ÿä¸€å“åº”æ ¼å¼
```typescript
interface ApiResponse<T = any> {
  success: boolean;
  code: number;
  message: string;
  data?: T;
  timestamp: string;
  requestId: string;
}

// æˆåŠŸå“åº”
{
  "success": true,
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": { /* ä¸šåŠ¡æ•°æ® */ },
  "timestamp": "2024-01-01T10:00:00Z",
  "requestId": "req_123456789"
}

// é”™è¯¯å“åº”
{
  "success": false,
  "code": 400,
  "message": "å‚æ•°é”™è¯¯",
  "data": null,
  "timestamp": "2024-01-01T10:00:00Z",
  "requestId": "req_123456789"
}
```

#### çŠ¶æ€ç è§„èŒƒ
```typescript
enum ApiStatusCode {
  // æˆåŠŸ
  SUCCESS = 200,
  CREATED = 201,
  
  // å®¢æˆ·ç«¯é”™è¯¯
  BAD_REQUEST = 400,
  UNAUTHORIZED = 401,
  FORBIDDEN = 403,
  NOT_FOUND = 404,
  CONFLICT = 409,
  
  // æœåŠ¡å™¨é”™è¯¯
  INTERNAL_ERROR = 500,
  SERVICE_UNAVAILABLE = 503
}
```

### 2. è®¤è¯é›†æˆæ¥å£

#### è®¤è¯é€‚é…å™¨æ¥å£
```typescript
interface AuthAdapter {
  // éªŒè¯token
  validateToken(token: string): Promise<AuthResult>;
  
  // è·å–ç”¨æˆ·ä¿¡æ¯
  getUserInfo(token: string): Promise<UserInfo>;
  
  // åˆ·æ–°token
  refreshToken(refreshToken: string): Promise<TokenResult>;
  
  // ç™»å‡º
  logout(token: string): Promise<void>;
}

interface AuthResult {
  valid: boolean;
  userId?: string;
  permissions?: string[];
  expiresAt?: Date;
}

interface UserInfo {
  id: string;
  username: string;
  email: string;
  name: string;
  avatar?: string;
  roles: string[];
  permissions: string[];
  department?: {
    id: string;
    name: string;
  };
}
```

### 3. æ•°æ®åŒæ­¥æ¥å£

#### ç”¨æˆ·æ•°æ®åŒæ­¥
```typescript
interface UserSyncAdapter {
  // åŒæ­¥ç”¨æˆ·ä¿¡æ¯
  syncUser(user: ExternalUser): Promise<InternalUser>;
  
  // æ‰¹é‡åŒæ­¥ç”¨æˆ·
  syncUsers(users: ExternalUser[]): Promise<SyncResult>;
  
  // ç”¨æˆ·å˜æ›´é€šçŸ¥
  onUserChanged(callback: (event: UserChangeEvent) => void): void;
}

interface UserChangeEvent {
  type: 'created' | 'updated' | 'deleted';
  userId: string;
  userData?: Partial<ExternalUser>;
  timestamp: Date;
}
```

## ğŸ“– æ•°æ®å­—å…¸è§„èŒƒ

### 1. æ ¸å¿ƒå®ä½“å­—å…¸

#### ç”¨æˆ·å®ä½“
```typescript
interface User {
  id: string;                    // ç”¨æˆ·ID
  username: string;              // ç”¨æˆ·å
  email: string;                 // é‚®ç®±
  name: string;                  // å§“å
  avatar?: string;               // å¤´åƒURL
  phone?: string;                // ç”µè¯
  status: UserStatus;            // ç”¨æˆ·çŠ¶æ€
  roles: Role[];                 // è§’è‰²åˆ—è¡¨
  department?: Department;       // æ‰€å±éƒ¨é—¨
  createdAt: Date;              // åˆ›å»ºæ—¶é—´
  updatedAt: Date;              // æ›´æ–°æ—¶é—´
}

enum UserStatus {
  ACTIVE = 'active',            // æ¿€æ´»
  INACTIVE = 'inactive',        // æœªæ¿€æ´»
  SUSPENDED = 'suspended',      // æš‚åœ
  DELETED = 'deleted'           // å·²åˆ é™¤
}
```

#### é¡¹ç›®å®ä½“
```typescript
interface Project {
  id: string;                   // é¡¹ç›®ID
  name: string;                 // é¡¹ç›®åç§°
  description?: string;         // é¡¹ç›®æè¿°
  status: ProjectStatus;        // é¡¹ç›®çŠ¶æ€
  priority: Priority;           // ä¼˜å…ˆçº§
  startDate?: Date;            // å¼€å§‹æ—¥æœŸ
  endDate?: Date;              // ç»“æŸæ—¥æœŸ
  progress: number;            // è¿›åº¦ç™¾åˆ†æ¯”
  owner: User;                 // é¡¹ç›®è´Ÿè´£äºº
  members: ProjectMember[];    // é¡¹ç›®æˆå‘˜
  tags: string[];              // æ ‡ç­¾
  createdAt: Date;            // åˆ›å»ºæ—¶é—´
  updatedAt: Date;            // æ›´æ–°æ—¶é—´
}

enum ProjectStatus {
  PLANNING = 'planning',        // è§„åˆ’ä¸­
  ACTIVE = 'active',           // è¿›è¡Œä¸­
  ON_HOLD = 'on_hold',         // æš‚åœ
  COMPLETED = 'completed',     // å·²å®Œæˆ
  CANCELLED = 'cancelled'      // å·²å–æ¶ˆ
}

enum Priority {
  LOW = 'low',                 // ä½
  MEDIUM = 'medium',           // ä¸­
  HIGH = 'high',               // é«˜
  URGENT = 'urgent'            // ç´§æ€¥
}
```

#### æ–‡ä»¶å®ä½“
```typescript
interface File {
  id: string;                  // æ–‡ä»¶ID
  filename: string;            // æ–‡ä»¶å
  originalName: string;        // åŸå§‹æ–‡ä»¶å
  mimetype: string;           // MIMEç±»å‹
  size: number;               // æ–‡ä»¶å¤§å°(å­—èŠ‚)
  category: FileCategory;     // æ–‡ä»¶åˆ†ç±»
  path: string;               // å­˜å‚¨è·¯å¾„
  url: string;                // è®¿é—®URL
  uploadedBy: User;           // ä¸Šä¼ è€…
  project?: Project;          // å…³è”é¡¹ç›®
  task?: Task;                // å…³è”ä»»åŠ¡
  permissions: FilePermission[]; // æƒé™è®¾ç½®
  tags: string[];             // æ ‡ç­¾
  isPublic: boolean;          // æ˜¯å¦å…¬å¼€
  downloadCount: number;      // ä¸‹è½½æ¬¡æ•°
  createdAt: Date;           // åˆ›å»ºæ—¶é—´
  updatedAt: Date;           // æ›´æ–°æ—¶é—´
}

enum FileCategory {
  DOCUMENT = 'document',       // æ–‡æ¡£
  IMAGE = 'image',            // å›¾ç‰‡
  VIDEO = 'video',            // è§†é¢‘
  AUDIO = 'audio',            // éŸ³é¢‘
  ARCHIVE = 'archive',        // å‹ç¼©åŒ…
  OTHER = 'other'             // å…¶ä»–
}
```

### 2. æƒé™å­—å…¸

#### æƒé™å®šä¹‰
```typescript
interface Permission {
  id: string;                 // æƒé™ID
  name: string;               // æƒé™åç§°
  code: string;               // æƒé™ä»£ç 
  resource: string;           // èµ„æºç±»å‹
  action: string;             // æ“ä½œç±»å‹
  description?: string;       // æƒé™æè¿°
}

// æƒé™ä»£ç è§„èŒƒ: {resource}:{action}
enum PermissionCode {
  // é¡¹ç›®æƒé™
  PROJECT_VIEW = 'project:view',
  PROJECT_CREATE = 'project:create',
  PROJECT_EDIT = 'project:edit',
  PROJECT_DELETE = 'project:delete',
  PROJECT_MANAGE_MEMBERS = 'project:manage_members',
  
  // æ–‡ä»¶æƒé™
  FILE_VIEW = 'file:view',
  FILE_UPLOAD = 'file:upload',
  FILE_DOWNLOAD = 'file:download',
  FILE_DELETE = 'file:delete',
  FILE_MANAGE_PERMISSIONS = 'file:manage_permissions',
  
  // æ¶ˆæ¯æƒé™
  MESSAGE_SEND = 'message:send',
  MESSAGE_VIEW = 'message:view',
  MESSAGE_DELETE = 'message:delete',
  
  // ç³»ç»Ÿæƒé™
  SYSTEM_ADMIN = 'system:admin',
  USER_MANAGE = 'user:manage'
}
```

### 3. é…ç½®å­—å…¸

#### ç³»ç»Ÿé…ç½®
```typescript
interface SystemConfig {
  // æ–‡ä»¶é…ç½®
  file: {
    maxSize: number;           // æœ€å¤§æ–‡ä»¶å¤§å°(MB)
    allowedTypes: string[];    // å…è®¸çš„æ–‡ä»¶ç±»å‹
    uploadPath: string;        // ä¸Šä¼ è·¯å¾„
    enablePreview: boolean;    // å¯ç”¨é¢„è§ˆ
  };
  
  // æ¶ˆæ¯é…ç½®
  message: {
    maxLength: number;         // æœ€å¤§æ¶ˆæ¯é•¿åº¦
    enableFileTransfer: boolean; // å¯ç”¨æ–‡ä»¶ä¼ è¾“
    retentionDays: number;     // æ¶ˆæ¯ä¿ç•™å¤©æ•°
  };
  
  // é¡¹ç›®é…ç½®
  project: {
    maxMembers: number;        // æœ€å¤§æˆå‘˜æ•°
    enableTimeTracking: boolean; // å¯ç”¨æ—¶é—´è·Ÿè¸ª
    defaultStatus: ProjectStatus; // é»˜è®¤çŠ¶æ€
  };
  
  // é›†æˆé…ç½®
  integration: {
    authProvider: string;      // è®¤è¯æä¾›è€…
    userSyncEnabled: boolean;  // å¯ç”¨ç”¨æˆ·åŒæ­¥
    apiPrefix: string;         // APIå‰ç¼€
    socketNamespace: string;   // Socketå‘½åç©ºé—´
  };
}
```

## ğŸ”§ é…ç½®ç®¡ç†æ–¹æ¡ˆ

### 1. ç¯å¢ƒé…ç½®

#### é…ç½®æ–‡ä»¶ç»“æ„
```
config/
â”œâ”€â”€ default.json              # é»˜è®¤é…ç½®
â”œâ”€â”€ development.json           # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ production.json            # ç”Ÿäº§ç¯å¢ƒ
â”œâ”€â”€ test.json                 # æµ‹è¯•ç¯å¢ƒ
â””â”€â”€ local.json                # æœ¬åœ°é…ç½®(gitå¿½ç•¥)
```

#### é…ç½®ç¤ºä¾‹
```json
// config/default.json
{
  "oa": {
    "module": {
      "name": "OA-System",
      "version": "1.0.0",
      "prefix": "/api/oa"
    },
    "database": {
      "type": "mongodb",
      "host": "localhost",
      "port": 27017,
      "name": "oa_system"
    },
    "auth": {
      "provider": "external",
      "tokenHeader": "Authorization",
      "tokenPrefix": "Bearer"
    },
    "file": {
      "storage": "local",
      "uploadPath": "./uploads",
      "maxSize": 10485760,
      "allowedTypes": [
        "image/jpeg", "image/png", "application/pdf"
      ]
    },
    "socket": {
      "namespace": "/oa",
      "cors": {
        "origin": "*",
        "methods": ["GET", "POST"]
      }
    }
  }
}
```

### 2. è¿è¡Œæ—¶é…ç½®

#### é…ç½®åŠ è½½å™¨
```typescript
class ConfigLoader {
  private config: any;
  
  constructor(environment: string = 'development') {
    this.loadConfig(environment);
  }
  
  private loadConfig(env: string): void {
    const defaultConfig = require('./config/default.json');
    const envConfig = require(`./config/${env}.json`);
    
    this.config = this.mergeConfig(defaultConfig, envConfig);
  }
  
  get(path: string, defaultValue?: any): any {
    return this.getNestedValue(this.config, path) || defaultValue;
  }
  
  private getNestedValue(obj: any, path: string): any {
    return path.split('.').reduce((current, key) => 
      current && current[key], obj
    );
  }
  
  private mergeConfig(base: any, override: any): any {
    // æ·±åº¦åˆå¹¶é…ç½®å¯¹è±¡
    return { ...base, ...override };
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const config = new ConfigLoader(process.env.NODE_ENV);
const dbHost = config.get('oa.database.host', 'localhost');
const apiPrefix = config.get('oa.module.prefix', '/api');
```

## ğŸ”Œ é›†æˆé€‚é…å™¨

### 1. è®¤è¯é€‚é…å™¨å®ç°

```typescript
// adapters/AuthAdapter.ts
export class ExternalAuthAdapter implements AuthAdapter {
  private apiClient: ApiClient;
  
  constructor(config: AuthConfig) {
    this.apiClient = new ApiClient(config.baseUrl);
  }
  
  async validateToken(token: string): Promise<AuthResult> {
    try {
      const response = await this.apiClient.post('/auth/validate', {
        token
      });
      
      return {
        valid: response.data.valid,
        userId: response.data.userId,
        permissions: response.data.permissions,
        expiresAt: new Date(response.data.expiresAt)
      };
    } catch (error) {
      return { valid: false };
    }
  }
  
  async getUserInfo(token: string): Promise<UserInfo> {
    const response = await this.apiClient.get('/user/me', {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    return this.transformUser(response.data);
  }
  
  private transformUser(externalUser: any): UserInfo {
    return {
      id: externalUser.id,
      username: externalUser.username,
      email: externalUser.email,
      name: externalUser.displayName || externalUser.name,
      avatar: externalUser.avatar,
      roles: externalUser.roles || [],
      permissions: externalUser.permissions || [],
      department: externalUser.department ? {
        id: externalUser.department.id,
        name: externalUser.department.name
      } : undefined
    };
  }
}
```

### 2. æ•°æ®åŒæ­¥é€‚é…å™¨

```typescript
// adapters/UserSyncAdapter.ts
export class UserSyncAdapter {
  private oaUserService: UserService;
  private externalApi: ApiClient;
  
  constructor(config: SyncConfig) {
    this.oaUserService = new UserService();
    this.externalApi = new ApiClient(config.externalApiUrl);
  }
  
  async syncUser(externalUser: ExternalUser): Promise<InternalUser> {
    // è½¬æ¢å¤–éƒ¨ç”¨æˆ·æ•°æ®æ ¼å¼
    const internalUser = this.transformUser(externalUser);
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    const existingUser = await this.oaUserService.findByExternalId(
      externalUser.id
    );
    
    if (existingUser) {
      // æ›´æ–°ç°æœ‰ç”¨æˆ·
      return await this.oaUserService.update(existingUser.id, internalUser);
    } else {
      // åˆ›å»ºæ–°ç”¨æˆ·
      return await this.oaUserService.create(internalUser);
    }
  }
  
  async syncUsers(externalUsers: ExternalUser[]): Promise<SyncResult> {
    const results = {
      success: 0,
      failed: 0,
      errors: [] as string[]
    };
    
    for (const user of externalUsers) {
      try {
        await this.syncUser(user);
        results.success++;
      } catch (error) {
        results.failed++;
        results.errors.push(`ç”¨æˆ· ${user.username}: ${error.message}`);
      }
    }
    
    return results;
  }
  
  private transformUser(external: ExternalUser): Partial<InternalUser> {
    return {
      externalId: external.id,
      username: external.username,
      email: external.email,
      name: external.displayName || external.name,
      avatar: external.avatar,
      phone: external.phone,
      status: this.mapUserStatus(external.status),
      department: external.department ? {
        externalId: external.department.id,
        name: external.department.name
      } : undefined
    };
  }
  
  private mapUserStatus(externalStatus: string): UserStatus {
    const statusMap: Record<string, UserStatus> = {
      'active': UserStatus.ACTIVE,
      'inactive': UserStatus.INACTIVE,
      'disabled': UserStatus.SUSPENDED,
      'deleted': UserStatus.DELETED
    };
    
    return statusMap[externalStatus] || UserStatus.INACTIVE;
  }
}
```

è¿™ä¸ªæ¨¡å—åŒ–ç§»æ¤æŒ‡å—æä¾›äº†å®Œæ•´çš„æ ‡å‡†åŒ–æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ¥å£è§„èŒƒã€æ•°æ®å­—å…¸ã€é…ç½®ç®¡ç†å’Œé€‚é…å™¨å®ç°ã€‚é€šè¿‡è¿™å¥—æ–¹æ¡ˆï¼ŒOAç³»ç»Ÿå¯ä»¥è½»æ¾é›†æˆåˆ°ä»»ä½•ç°æœ‰çš„ç½‘é¡µç³»ç»Ÿä¸­ã€‚

æ‚¨å¸Œæœ›æˆ‘ç»§ç»­å®Œå–„æŸä¸ªç‰¹å®šéƒ¨åˆ†ï¼Œæ¯”å¦‚å…·ä½“çš„ç§»æ¤æ­¥éª¤æˆ–è€…å‰ç«¯ç»„ä»¶çš„æ¨¡å—åŒ–æ–¹æ¡ˆå—ï¼Ÿ
