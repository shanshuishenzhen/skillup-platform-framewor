# OAæ¨¡å—é›†æˆä½¿ç”¨ç¤ºä¾‹

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†å°†OAç³»ç»Ÿä½œä¸ºå­æ¨¡å—é›†æˆåˆ°å…¶ä»–ç½‘é¡µç³»ç»Ÿçš„å®Œæ•´ç¤ºä¾‹ï¼ŒåŒ…æ‹¬ä¸åŒåœºæ™¯ä¸‹çš„é›†æˆæ–¹æ¡ˆå’Œä»£ç ç¤ºä¾‹ã€‚

## ğŸš€ å¿«é€Ÿé›†æˆç¤ºä¾‹

### 1. Express.js åº”ç”¨é›†æˆ

```javascript
// app.js - ä¸»åº”ç”¨å…¥å£æ–‡ä»¶
const express = require('express');
const OAModuleAdapter = require('./integration/OAModuleAdapter');

const app = express();

// åŸºç¡€ä¸­é—´ä»¶
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// åˆå§‹åŒ–OAæ¨¡å—
const oaModule = new OAModuleAdapter({
    module: {
        prefix: '/api/oa'
    },
    auth: {
        provider: 'external',
        validateUrl: 'http://main-system/api/auth/validate',
        userInfoUrl: 'http://main-system/api/auth/me'
    },
    database: {
        type: 'mongodb',
        host: 'localhost',
        port: 27017,
        name: 'main_system_oa'
    },
    userSync: {
        enabled: true,
        syncUrl: 'http://main-system/api/users',
        syncInterval: 3600000 // 1å°æ—¶åŒæ­¥ä¸€æ¬¡
    }
});

// å¯åŠ¨åº”ç”¨
async function startApp() {
    try {
        // åˆå§‹åŒ–OAæ¨¡å—
        await oaModule.initialize();
        
        // æŒ‚è½½OAè·¯ç”±
        app.use('/api/oa', oaModule.getRoutes());
        
        // ä¸»ç³»ç»Ÿè·¯ç”±
        app.use('/api/main', require('./routes/main'));
        
        // å¥åº·æ£€æŸ¥
        app.get('/health', (req, res) => {
            res.json({
                status: 'OK',
                oa: oaModule.getStatus()
            });
        });
        
        const PORT = process.env.PORT || 3000;
        app.listen(PORT, () => {
            console.log(`æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ ${PORT}`);
        });
        
    } catch (error) {
        console.error('åº”ç”¨å¯åŠ¨å¤±è´¥:', error);
        process.exit(1);
    }
}

startApp();
```

### 2. è‡ªå®šä¹‰è®¤è¯é€‚é…å™¨

```javascript
// adapters/CustomAuthAdapter.js
class CustomAuthAdapter {
    constructor(config) {
        this.config = config;
        this.apiClient = new ApiClient(config.baseUrl);
    }
    
    async validateToken(token) {
        try {
            const response = await this.apiClient.post('/auth/validate', {
                token: token
            }, {
                headers: {
                    'X-API-Key': this.config.apiKey
                }
            });
            
            return {
                valid: response.data.success,
                userId: response.data.user?.id,
                permissions: response.data.user?.permissions || [],
                expiresAt: response.data.expiresAt ? new Date(response.data.expiresAt) : null
            };
            
        } catch (error) {
            console.error('TokenéªŒè¯å¤±è´¥:', error);
            return { valid: false };
        }
    }
    
    async getUserInfo(token) {
        const response = await this.apiClient.get('/user/profile', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'X-API-Key': this.config.apiKey
            }
        });
        
        // è½¬æ¢ç”¨æˆ·æ•°æ®æ ¼å¼
        return this.transformUserData(response.data);
    }
    
    transformUserData(userData) {
        return {
            id: userData.user_id,
            username: userData.login_name,
            email: userData.email_address,
            name: userData.display_name,
            avatar: userData.profile_image,
            roles: userData.user_roles || [],
            permissions: userData.user_permissions || [],
            department: userData.department_info ? {
                id: userData.department_info.dept_id,
                name: userData.department_info.dept_name
            } : null
        };
    }
}

module.exports = CustomAuthAdapter;
```

### 3. ç”¨æˆ·æ•°æ®åŒæ­¥é€‚é…å™¨

```javascript
// adapters/UserSyncAdapter.js
class UserSyncAdapter {
    constructor(config) {
        this.config = config;
        this.apiClient = new ApiClient(config.syncUrl);
        this.userService = new UserService();
    }
    
    async syncAllUsers() {
        try {
            let page = 1;
            let hasMore = true;
            const results = { success: 0, failed: 0, errors: [] };
            
            while (hasMore) {
                const response = await this.apiClient.get('/users', {
                    params: {
                        page: page,
                        limit: this.config.batchSize || 100,
                        include_inactive: false
                    }
                });
                
                const users = response.data.users || [];
                
                for (const user of users) {
                    try {
                        await this.syncUser(user);
                        results.success++;
                    } catch (error) {
                        results.failed++;
                        results.errors.push(`ç”¨æˆ· ${user.username}: ${error.message}`);
                    }
                }
                
                hasMore = users.length === this.config.batchSize;
                page++;
            }
            
            return results;
            
        } catch (error) {
            throw new Error(`ç”¨æˆ·åŒæ­¥å¤±è´¥: ${error.message}`);
        }
    }
    
    async syncUser(externalUser) {
        const internalUser = this.transformUser(externalUser);
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
        const existingUser = await this.userService.findByExternalId(externalUser.id);
        
        if (existingUser) {
            // æ›´æ–°ç°æœ‰ç”¨æˆ·
            return await this.userService.update(existingUser.id, internalUser);
        } else {
            // åˆ›å»ºæ–°ç”¨æˆ·
            return await this.userService.create(internalUser);
        }
    }
    
    transformUser(externalUser) {
        return {
            externalId: externalUser.id,
            username: externalUser.username,
            email: externalUser.email,
            name: externalUser.display_name || externalUser.name,
            avatar: externalUser.avatar_url,
            phone: externalUser.phone_number,
            status: this.mapUserStatus(externalUser.status),
            roles: externalUser.roles || ['employee'],
            department: externalUser.department ? {
                externalId: externalUser.department.id,
                name: externalUser.department.name
            } : null
        };
    }
    
    mapUserStatus(externalStatus) {
        const statusMap = {
            'active': 'active',
            'inactive': 'inactive',
            'disabled': 'suspended',
            'deleted': 'deleted'
        };
        
        return statusMap[externalStatus] || 'inactive';
    }
}

module.exports = UserSyncAdapter;
```

## ğŸ”§ é…ç½®ç¤ºä¾‹

### 1. å¼€å‘ç¯å¢ƒé…ç½®

```json
// config/development.json
{
  "oa": {
    "module": {
      "name": "OA-Development",
      "prefix": "/api/oa",
      "debug": true
    },
    "auth": {
      "provider": "external",
      "validateUrl": "http://localhost:8080/api/auth/validate",
      "userInfoUrl": "http://localhost:8080/api/auth/me",
      "timeout": 5000
    },
    "database": {
      "type": "mongodb",
      "host": "localhost",
      "port": 27017,
      "name": "dev_oa_system"
    },
    "file": {
      "uploadPath": "./uploads/dev",
      "maxSize": 5242880,
      "enablePreview": true
    },
    "socket": {
      "enabled": true,
      "namespace": "/oa",
      "cors": {
        "origin": "http://localhost:3000",
        "credentials": true
      }
    },
    "userSync": {
      "enabled": true,
      "syncUrl": "http://localhost:8080/api/users",
      "syncInterval": 300000,
      "batchSize": 50
    }
  }
}
```

### 2. ç”Ÿäº§ç¯å¢ƒé…ç½®

```json
// config/production.json
{
  "oa": {
    "module": {
      "name": "OA-Production",
      "prefix": "/api/oa",
      "debug": false
    },
    "auth": {
      "provider": "external",
      "validateUrl": "https://api.company.com/auth/validate",
      "userInfoUrl": "https://api.company.com/auth/me",
      "timeout": 10000,
      "retries": 3
    },
    "database": {
      "type": "mongodb",
      "host": "mongodb.company.com",
      "port": 27017,
      "name": "prod_oa_system",
      "options": {
        "ssl": true,
        "authSource": "admin"
      }
    },
    "file": {
      "storage": "oss",
      "uploadPath": "/data/uploads",
      "maxSize": 10485760,
      "enablePreview": true,
      "enableVersionControl": true
    },
    "socket": {
      "enabled": true,
      "namespace": "/oa",
      "cors": {
        "origin": ["https://app.company.com", "https://admin.company.com"],
        "credentials": true
      }
    },
    "userSync": {
      "enabled": true,
      "syncUrl": "https://api.company.com/users",
      "syncInterval": 3600000,
      "batchSize": 100
    }
  }
}
```

## ğŸ¯ é›†æˆåœºæ™¯ç¤ºä¾‹

### 1. å¾®æœåŠ¡æ¶æ„é›†æˆ

```javascript
// microservice-integration.js
const express = require('express');
const { createProxyMiddleware } = require('http-proxy-middleware');
const OAModuleAdapter = require('./integration/OAModuleAdapter');

const app = express();

// OAæ¨¡å—é…ç½®
const oaModule = new OAModuleAdapter({
    auth: {
        provider: 'external',
        validateUrl: 'http://auth-service:3001/validate',
        userInfoUrl: 'http://user-service:3002/me'
    },
    database: {
        host: 'mongodb-service',
        name: 'oa_microservice'
    }
});

// åˆå§‹åŒ–å¹¶å¯åŠ¨
async function start() {
    await oaModule.initialize();
    
    // OAæ¨¡å—è·¯ç”±
    app.use('/api/oa', oaModule.getRoutes());
    
    // ä»£ç†å…¶ä»–å¾®æœåŠ¡
    app.use('/api/auth', createProxyMiddleware({
        target: 'http://auth-service:3001',
        changeOrigin: true
    }));
    
    app.use('/api/users', createProxyMiddleware({
        target: 'http://user-service:3002',
        changeOrigin: true
    }));
    
    app.listen(3000);
}

start().catch(console.error);
```

### 2. å•é¡µåº”ç”¨(SPA)é›†æˆ

```javascript
// spa-integration.js
const express = require('express');
const path = require('path');
const OAModuleAdapter = require('./integration/OAModuleAdapter');

const app = express();

// é™æ€æ–‡ä»¶æœåŠ¡
app.use(express.static(path.join(__dirname, 'public')));

// OAæ¨¡å—
const oaModule = new OAModuleAdapter({
    auth: {
        provider: 'internal', // ä½¿ç”¨å†…éƒ¨è®¤è¯
        jwtSecret: process.env.JWT_SECRET
    }
});

async function start() {
    await oaModule.initialize();
    
    // APIè·¯ç”±
    app.use('/api/oa', oaModule.getRoutes());
    
    // SPAè·¯ç”± - æ‰€æœ‰å…¶ä»–è¯·æ±‚è¿”å›index.html
    app.get('*', (req, res) => {
        res.sendFile(path.join(__dirname, 'public/index.html'));
    });
    
    app.listen(3000);
}

start().catch(console.error);
```

### 3. å¤šç§Ÿæˆ·é›†æˆ

```javascript
// multi-tenant-integration.js
const express = require('express');
const OAModuleAdapter = require('./integration/OAModuleAdapter');

const app = express();

// ç§Ÿæˆ·è¯†åˆ«ä¸­é—´ä»¶
app.use((req, res, next) => {
    const tenantId = req.headers['x-tenant-id'] || req.query.tenant;
    if (!tenantId) {
        return res.status(400).json({ error: 'ç¼ºå°‘ç§Ÿæˆ·æ ‡è¯†' });
    }
    req.tenantId = tenantId;
    next();
});

// ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºOAæ¨¡å—å®ä¾‹
const oaModules = new Map();

async function getOAModule(tenantId) {
    if (!oaModules.has(tenantId)) {
        const module = new OAModuleAdapter({
            database: {
                name: `oa_tenant_${tenantId}`
            },
            auth: {
                validateUrl: `http://auth-service/validate/${tenantId}`
            }
        });
        
        await module.initialize();
        oaModules.set(tenantId, module);
    }
    
    return oaModules.get(tenantId);
}

// åŠ¨æ€è·¯ç”±å¤„ç†
app.use('/api/oa', async (req, res, next) => {
    try {
        const oaModule = await getOAModule(req.tenantId);
        const router = oaModule.getRoutes();
        router(req, res, next);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

app.listen(3000);
```

## ğŸ”Œ å‰ç«¯é›†æˆç¤ºä¾‹

### 1. Reacté›†æˆ

```jsx
// OAProvider.jsx
import React, { createContext, useContext, useEffect, useState } from 'react';
import axios from 'axios';
import io from 'socket.io-client';

const OAContext = createContext();

export const useOA = () => {
    const context = useContext(OAContext);
    if (!context) {
        throw new Error('useOA must be used within OAProvider');
    }
    return context;
};

export const OAProvider = ({ children, config }) => {
    const [socket, setSocket] = useState(null);
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);

    // é…ç½®axios
    const apiClient = axios.create({
        baseURL: config.apiBaseUrl || '/api/oa',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
    });

    // åˆå§‹åŒ–Socketè¿æ¥
    useEffect(() => {
        const token = localStorage.getItem('token');
        if (token) {
            const socketInstance = io(config.socketUrl || '', {
                auth: { token },
                namespace: config.socketNamespace || '/oa'
            });

            socketInstance.on('connect', () => {
                console.log('OA Socketè¿æ¥æˆåŠŸ');
            });

            setSocket(socketInstance);

            return () => socketInstance.disconnect();
        }
    }, [config]);

    // è·å–ç”¨æˆ·ä¿¡æ¯
    useEffect(() => {
        const fetchUser = async () => {
            try {
                const response = await apiClient.get('/auth/me');
                setUser(response.data.user);
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            } finally {
                setLoading(false);
            }
        };

        fetchUser();
    }, []);

    const value = {
        apiClient,
        socket,
        user,
        loading,
        // OAåŠŸèƒ½æ–¹æ³•
        sendMessage: (roomId, content) => {
            if (socket) {
                socket.emit('send_message', { roomId, content });
            }
        },
        uploadFile: async (file, projectId) => {
            const formData = new FormData();
            formData.append('file', file);
            if (projectId) formData.append('projectId', projectId);
            
            return await apiClient.post('/files/upload', formData);
        }
    };

    return (
        <OAContext.Provider value={value}>
            {children}
        </OAContext.Provider>
    );
};
```

### 2. Vue.jsé›†æˆ

```javascript
// oa-plugin.js
import axios from 'axios';
import io from 'socket.io-client';

export default {
    install(app, options) {
        const config = {
            apiBaseUrl: '/api/oa',
            socketNamespace: '/oa',
            ...options
        };

        // åˆ›å»ºAPIå®¢æˆ·ç«¯
        const apiClient = axios.create({
            baseURL: config.apiBaseUrl
        });

        // è¯·æ±‚æ‹¦æˆªå™¨ - æ·»åŠ token
        apiClient.interceptors.request.use(config => {
            const token = localStorage.getItem('token');
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }
            return config;
        });

        // Socketè¿æ¥
        let socket = null;
        const connectSocket = (token) => {
            if (socket) socket.disconnect();
            
            socket = io(config.socketUrl || '', {
                auth: { token },
                namespace: config.socketNamespace
            });
            
            return socket;
        };

        // å…¨å±€å±æ€§
        app.config.globalProperties.$oa = {
            api: apiClient,
            socket: null,
            connect: connectSocket,
            
            // ä¾¿æ·æ–¹æ³•
            async getProjects() {
                const response = await apiClient.get('/projects');
                return response.data;
            },
            
            async uploadFile(file, projectId) {
                const formData = new FormData();
                formData.append('file', file);
                if (projectId) formData.append('projectId', projectId);
                
                const response = await apiClient.post('/files/upload', formData);
                return response.data;
            },
            
            sendMessage(roomId, content) {
                if (this.socket) {
                    this.socket.emit('send_message', { roomId, content });
                }
            }
        };

        // æä¾›ä¾èµ–æ³¨å…¥
        app.provide('oa', app.config.globalProperties.$oa);
    }
};
```

## ğŸ“ éƒ¨ç½²è„šæœ¬ç¤ºä¾‹

### 1. Dockeréƒ¨ç½²

```dockerfile
# Dockerfile
FROM node:16-alpine

WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./
RUN npm ci --only=production

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºä¸Šä¼ ç›®å½•
RUN mkdir -p uploads

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨åº”ç”¨
CMD ["node", "app.js"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - MONGODB_URI=mongodb://mongo:27017/oa_system
    depends_on:
      - mongo
    volumes:
      - ./uploads:/app/uploads

  mongo:
    image: mongo:5.0
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

volumes:
  mongo_data:
```

### 2. PM2éƒ¨ç½²

```javascript
// ecosystem.config.js
module.exports = {
    apps: [{
        name: 'oa-system',
        script: 'app.js',
        instances: 'max',
        exec_mode: 'cluster',
        env: {
            NODE_ENV: 'development',
            PORT: 3000
        },
        env_production: {
            NODE_ENV: 'production',
            PORT: 3000,
            MONGODB_URI: 'mongodb://localhost:27017/oa_production'
        }
    }]
};
```

è¿™äº›ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨ä¸åŒåœºæ™¯ä¸‹é›†æˆOAæ¨¡å—ï¼ŒåŒ…æ‹¬é…ç½®ç®¡ç†ã€è®¤è¯é€‚é…ã€æ•°æ®åŒæ­¥å’Œå‰ç«¯é›†æˆç­‰å„ä¸ªæ–¹é¢ã€‚é€šè¿‡è¿™äº›ç¤ºä¾‹ï¼Œå¯ä»¥å¿«é€Ÿå°†OAç³»ç»Ÿé›†æˆåˆ°ç°æœ‰çš„ç½‘é¡µç³»ç»Ÿä¸­ã€‚
