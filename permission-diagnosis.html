<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>权限诊断工具</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .code {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .refresh-btn {
            background-color: #28a745;
        }
        .refresh-btn:hover {
            background-color: #1e7e34;
        }
        .clear-btn {
            background-color: #dc3545;
        }
        .clear-btn:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 权限诊断工具</h1>
        
        <div class="section">
            <h3>📋 诊断操作</h3>
            <button onclick="runDiagnosis()">🔍 开始诊断</button>
            <button onclick="clearResults()">🗑️ 清除结果</button>
            <button onclick="location.reload()" class="refresh-btn">🔄 刷新页面</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        /**
         * 运行完整的权限诊断
         * 检查localStorage中的token信息，解析payload，验证权限
         */
        function runDiagnosis() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            console.log('🔍 开始权限诊断...');
            
            // 1. 检查localStorage中的token
            checkTokenExistence();
            
            // 2. 检查用户信息
            checkUserInfo();
            
            // 3. 解析和验证token
            parseAndValidateToken();
            
            // 4. 检查权限相关的API
            checkPermissionAPI();
            
            // 5. 生成诊断报告
            generateDiagnosisReport();
        }

        /**
         * 检查localStorage中是否存在token
         */
        function checkTokenExistence() {
            const section = createSection('🔑 Token 存在性检查');
            
            const token = localStorage.getItem('token');
            const refreshToken = localStorage.getItem('refreshToken');
            
            if (token) {
                addStatus(section, 'success', `✅ Access Token 存在 (长度: ${token.length})`);
                addCode(section, `Token 前缀: ${token.substring(0, 50)}...`);
            } else {
                addStatus(section, 'error', '❌ Access Token 不存在');
            }
            
            if (refreshToken) {
                addStatus(section, 'success', `✅ Refresh Token 存在 (长度: ${refreshToken.length})`);
            } else {
                addStatus(section, 'warning', '⚠️ Refresh Token 不存在');
            }
            
            // 检查其他相关的localStorage项
            const user = localStorage.getItem('user');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            
            addStatus(section, user ? 'success' : 'warning', 
                user ? '✅ 用户信息存在' : '⚠️ 用户信息不存在');
            addStatus(section, isLoggedIn ? 'success' : 'warning', 
                isLoggedIn ? `✅ 登录状态: ${isLoggedIn}` : '⚠️ 登录状态未设置');
        }

        /**
         * 检查用户信息
         */
        function checkUserInfo() {
            const section = createSection('👤 用户信息检查');
            
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    addStatus(section, 'success', '✅ 用户信息解析成功');
                    
                    const userInfo = {
                        'ID': user.id || '未设置',
                        '手机号': user.phone || '未设置',
                        '邮箱': user.email || '未设置',
                        '用户类型': user.userType || '未设置',
                        '角色': user.role || '未设置',
                        '姓名': user.name || '未设置'
                    };
                    
                    let userInfoText = '用户信息详情:\n';
                    for (const [key, value] of Object.entries(userInfo)) {
                        userInfoText += `${key}: ${value}\n`;
                    }
                    addCode(section, userInfoText);
                    
                    // 检查关键字段
                    if (user.role === 'admin' || user.role === 'super_admin') {
                        addStatus(section, 'success', `✅ 用户角色为管理员: ${user.role}`);
                    } else {
                        addStatus(section, 'error', `❌ 用户角色不是管理员: ${user.role || '未设置'}`);
                    }
                    
                } catch (error) {
                    addStatus(section, 'error', `❌ 用户信息解析失败: ${error.message}`);
                }
            } else {
                addStatus(section, 'error', '❌ 用户信息不存在');
            }
        }

        /**
         * 解析和验证JWT token
         */
        function parseAndValidateToken() {
            const section = createSection('🔐 JWT Token 解析与验证');
            
            const token = localStorage.getItem('token');
            if (!token) {
                addStatus(section, 'error', '❌ 无法解析：Token 不存在');
                return;
            }
            
            try {
                // 解析JWT token
                const payload = parseJWTToken(token);
                
                if (payload) {
                    addStatus(section, 'success', '✅ JWT Token 解析成功');
                    
                    // 显示payload内容
                    const payloadInfo = {
                        '用户ID': payload.userId || '未设置',
                        '用户类型': payload.userType || '未设置',
                        '角色': payload.role || '未设置',
                        'Token类型': payload.type || '未设置',
                        '签发时间': payload.iat ? new Date(payload.iat * 1000).toLocaleString() : '未设置',
                        '过期时间': payload.exp ? new Date(payload.exp * 1000).toLocaleString() : '未设置'
                    };
                    
                    let payloadText = 'JWT Payload 详情:\n';
                    for (const [key, value] of Object.entries(payloadInfo)) {
                        payloadText += `${key}: ${value}\n`;
                    }
                    addCode(section, payloadText);
                    
                    // 检查token是否过期
                    const isExpired = isTokenExpired(payload);
                    if (isExpired) {
                        addStatus(section, 'error', '❌ Token 已过期');
                    } else {
                        addStatus(section, 'success', '✅ Token 未过期');
                    }
                    
                    // 检查管理员权限
                    const hasAdminRole = payload.role === 'admin' || payload.role === 'super_admin';
                    if (hasAdminRole) {
                        addStatus(section, 'success', `✅ 具有管理员权限: ${payload.role}`);
                    } else {
                        addStatus(section, 'error', `❌ 不具有管理员权限: ${payload.role || '未设置'}`);
                    }
                    
                } else {
                    addStatus(section, 'error', '❌ JWT Token 解析失败');
                }
                
            } catch (error) {
                addStatus(section, 'error', `❌ JWT Token 解析异常: ${error.message}`);
                addCode(section, `错误详情: ${error.stack}`);
            }
        }

        /**
         * 检查权限相关的API
         */
        function checkPermissionAPI() {
            const section = createSection('🌐 权限API检查');
            
            const token = localStorage.getItem('token');
            if (!token) {
                addStatus(section, 'error', '❌ 无法测试API：Token 不存在');
                return;
            }
            
            addStatus(section, 'info', '🔄 正在测试权限API...');
            
            // 测试权限检查API
            fetch('/api/auth/check-permission', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                addStatus(section, 'info', `📡 权限检查API响应状态: ${response.status}`);
                return response.json();
            })
            .then(data => {
                addStatus(section, 'success', '✅ 权限检查API响应成功');
                addCode(section, `API响应数据:\n${JSON.stringify(data, null, 2)}`);
            })
            .catch(error => {
                addStatus(section, 'error', `❌ 权限检查API请求失败: ${error.message}`);
            });
            
            // 测试用户列表API
            fetch('/api/users', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                addStatus(section, 'info', `📡 用户列表API响应状态: ${response.status}`);
                if (response.status === 200) {
                    addStatus(section, 'success', '✅ 用户列表API访问成功');
                } else if (response.status === 401) {
                    addStatus(section, 'error', '❌ 用户列表API: 未授权 (401)');
                } else if (response.status === 403) {
                    addStatus(section, 'error', '❌ 用户列表API: 权限不足 (403)');
                } else {
                    addStatus(section, 'warning', `⚠️ 用户列表API: 其他错误 (${response.status})`);
                }
                return response.text();
            })
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    addCode(section, `用户列表API响应:\n${JSON.stringify(data, null, 2)}`);
                } catch {
                    addCode(section, `用户列表API响应 (文本):\n${text}`);
                }
            })
            .catch(error => {
                addStatus(section, 'error', `❌ 用户列表API请求失败: ${error.message}`);
            });
        }

        /**
         * 生成诊断报告
         */
        function generateDiagnosisReport() {
            const section = createSection('📊 诊断报告');
            
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            let report = '=== 权限诊断报告 ===\n\n';
            report += `诊断时间: ${new Date().toLocaleString()}\n\n`;
            
            // 基础检查
            report += '1. 基础检查:\n';
            report += `   - Token存在: ${token ? '✅ 是' : '❌ 否'}\n`;
            report += `   - 用户信息存在: ${user ? '✅ 是' : '❌ 否'}\n`;
            
            if (token) {
                try {
                    const payload = parseJWTToken(token);
                    if (payload) {
                        report += '\n2. Token信息:\n';
                        report += `   - 用户ID: ${payload.userId || '未设置'}\n`;
                        report += `   - 角色: ${payload.role || '未设置'}\n`;
                        report += `   - 用户类型: ${payload.userType || '未设置'}\n`;
                        report += `   - 过期状态: ${isTokenExpired(payload) ? '❌ 已过期' : '✅ 未过期'}\n`;
                        
                        const hasAdmin = payload.role === 'admin' || payload.role === 'super_admin';
                        report += `   - 管理员权限: ${hasAdmin ? '✅ 有' : '❌ 无'}\n`;
                    }
                } catch (error) {
                    report += '\n2. Token解析失败\n';
                }
            }
            
            if (user) {
                try {
                    const userObj = JSON.parse(user);
                    report += '\n3. 用户信息:\n';
                    report += `   - 手机号: ${userObj.phone || '未设置'}\n`;
                    report += `   - 邮箱: ${userObj.email || '未设置'}\n`;
                    report += `   - 角色: ${userObj.role || '未设置'}\n`;
                } catch (error) {
                    report += '\n3. 用户信息解析失败\n';
                }
            }
            
            report += '\n4. 建议操作:\n';
            if (!token) {
                report += '   - 重新登录获取有效token\n';
            } else {
                const payload = parseJWTToken(token);
                if (payload && isTokenExpired(payload)) {
                    report += '   - Token已过期，需要刷新或重新登录\n';
                }
                if (payload && payload.role !== 'admin' && payload.role !== 'super_admin') {
                    report += '   - 当前用户不是管理员，无法访问管理功能\n';
                }
            }
            
            addCode(section, report);
        }

        /**
         * 解析JWT token的payload部分
         * @param {string} token - JWT token字符串
         * @returns {object|null} 解析后的payload对象
         */
        function parseJWTToken(token) {
            try {
                // 移除Bearer前缀（如果存在）
                const cleanToken = token.replace(/^Bearer\s+/i, '').trim();
                
                // 分割token
                const parts = cleanToken.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format');
                }
                
                // 解码payload部分
                const payload = parts[1];
                
                // Base64URL解码
                const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
                
                // 解析JSON
                return JSON.parse(decoded);
            } catch (error) {
                console.error('JWT解析错误:', error);
                return null;
            }
        }

        /**
         * 检查token是否过期
         * @param {object} payload - JWT payload对象
         * @returns {boolean} 是否过期
         */
        function isTokenExpired(payload) {
            if (!payload || !payload.exp) {
                return true;
            }
            
            const currentTime = Math.floor(Date.now() / 1000);
            return payload.exp < currentTime;
        }

        /**
         * 创建诊断结果区域
         * @param {string} title - 区域标题
         * @returns {HTMLElement} 创建的区域元素
         */
        function createSection(title) {
            const resultsDiv = document.getElementById('results');
            const section = document.createElement('div');
            section.className = 'section';
            
            const titleElement = document.createElement('h3');
            titleElement.textContent = title;
            section.appendChild(titleElement);
            
            resultsDiv.appendChild(section);
            return section;
        }

        /**
         * 添加状态信息
         * @param {HTMLElement} section - 目标区域
         * @param {string} type - 状态类型 (success, error, warning, info)
         * @param {string} message - 状态消息
         */
        function addStatus(section, type, message) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            section.appendChild(statusDiv);
        }

        /**
         * 添加代码块
         * @param {HTMLElement} section - 目标区域
         * @param {string} code - 代码内容
         */
        function addCode(section, code) {
            const codeDiv = document.createElement('div');
            codeDiv.className = 'code';
            codeDiv.textContent = code;
            section.appendChild(codeDiv);
        }

        /**
         * 清除诊断结果
         */
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // 页面加载完成后自动运行诊断
        window.addEventListener('load', function() {
            console.log('权限诊断工具已加载');
        });
    </script>
</body>
</html>