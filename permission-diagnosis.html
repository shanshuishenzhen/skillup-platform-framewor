<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒé™è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .code {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .refresh-btn {
            background-color: #28a745;
        }
        .refresh-btn:hover {
            background-color: #1e7e34;
        }
        .clear-btn {
            background-color: #dc3545;
        }
        .clear-btn:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æƒé™è¯Šæ–­å·¥å…·</h1>
        
        <div class="section">
            <h3>ğŸ“‹ è¯Šæ–­æ“ä½œ</h3>
            <button onclick="runDiagnosis()">ğŸ” å¼€å§‹è¯Šæ–­</button>
            <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
            <button onclick="location.reload()" class="refresh-btn">ğŸ”„ åˆ·æ–°é¡µé¢</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        /**
         * è¿è¡Œå®Œæ•´çš„æƒé™è¯Šæ–­
         * æ£€æŸ¥localStorageä¸­çš„tokenä¿¡æ¯ï¼Œè§£æpayloadï¼ŒéªŒè¯æƒé™
         */
        function runDiagnosis() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            console.log('ğŸ” å¼€å§‹æƒé™è¯Šæ–­...');
            
            // 1. æ£€æŸ¥localStorageä¸­çš„token
            checkTokenExistence();
            
            // 2. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
            checkUserInfo();
            
            // 3. è§£æå’ŒéªŒè¯token
            parseAndValidateToken();
            
            // 4. æ£€æŸ¥æƒé™ç›¸å…³çš„API
            checkPermissionAPI();
            
            // 5. ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
            generateDiagnosisReport();
        }

        /**
         * æ£€æŸ¥localStorageä¸­æ˜¯å¦å­˜åœ¨token
         */
        function checkTokenExistence() {
            const section = createSection('ğŸ”‘ Token å­˜åœ¨æ€§æ£€æŸ¥');
            
            const token = localStorage.getItem('token');
            const refreshToken = localStorage.getItem('refreshToken');
            
            if (token) {
                addStatus(section, 'success', `âœ… Access Token å­˜åœ¨ (é•¿åº¦: ${token.length})`);
                addCode(section, `Token å‰ç¼€: ${token.substring(0, 50)}...`);
            } else {
                addStatus(section, 'error', 'âŒ Access Token ä¸å­˜åœ¨');
            }
            
            if (refreshToken) {
                addStatus(section, 'success', `âœ… Refresh Token å­˜åœ¨ (é•¿åº¦: ${refreshToken.length})`);
            } else {
                addStatus(section, 'warning', 'âš ï¸ Refresh Token ä¸å­˜åœ¨');
            }
            
            // æ£€æŸ¥å…¶ä»–ç›¸å…³çš„localStorageé¡¹
            const user = localStorage.getItem('user');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            
            addStatus(section, user ? 'success' : 'warning', 
                user ? 'âœ… ç”¨æˆ·ä¿¡æ¯å­˜åœ¨' : 'âš ï¸ ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨');
            addStatus(section, isLoggedIn ? 'success' : 'warning', 
                isLoggedIn ? `âœ… ç™»å½•çŠ¶æ€: ${isLoggedIn}` : 'âš ï¸ ç™»å½•çŠ¶æ€æœªè®¾ç½®');
        }

        /**
         * æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
         */
        function checkUserInfo() {
            const section = createSection('ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯æ£€æŸ¥');
            
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    addStatus(section, 'success', 'âœ… ç”¨æˆ·ä¿¡æ¯è§£ææˆåŠŸ');
                    
                    const userInfo = {
                        'ID': user.id || 'æœªè®¾ç½®',
                        'æ‰‹æœºå·': user.phone || 'æœªè®¾ç½®',
                        'é‚®ç®±': user.email || 'æœªè®¾ç½®',
                        'ç”¨æˆ·ç±»å‹': user.userType || 'æœªè®¾ç½®',
                        'è§’è‰²': user.role || 'æœªè®¾ç½®',
                        'å§“å': user.name || 'æœªè®¾ç½®'
                    };
                    
                    let userInfoText = 'ç”¨æˆ·ä¿¡æ¯è¯¦æƒ…:\n';
                    for (const [key, value] of Object.entries(userInfo)) {
                        userInfoText += `${key}: ${value}\n`;
                    }
                    addCode(section, userInfoText);
                    
                    // æ£€æŸ¥å…³é”®å­—æ®µ
                    if (user.role === 'admin' || user.role === 'super_admin') {
                        addStatus(section, 'success', `âœ… ç”¨æˆ·è§’è‰²ä¸ºç®¡ç†å‘˜: ${user.role}`);
                    } else {
                        addStatus(section, 'error', `âŒ ç”¨æˆ·è§’è‰²ä¸æ˜¯ç®¡ç†å‘˜: ${user.role || 'æœªè®¾ç½®'}`);
                    }
                    
                } catch (error) {
                    addStatus(section, 'error', `âŒ ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥: ${error.message}`);
                }
            } else {
                addStatus(section, 'error', 'âŒ ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨');
            }
        }

        /**
         * è§£æå’ŒéªŒè¯JWT token
         */
        function parseAndValidateToken() {
            const section = createSection('ğŸ” JWT Token è§£æä¸éªŒè¯');
            
            const token = localStorage.getItem('token');
            if (!token) {
                addStatus(section, 'error', 'âŒ æ— æ³•è§£æï¼šToken ä¸å­˜åœ¨');
                return;
            }
            
            try {
                // è§£æJWT token
                const payload = parseJWTToken(token);
                
                if (payload) {
                    addStatus(section, 'success', 'âœ… JWT Token è§£ææˆåŠŸ');
                    
                    // æ˜¾ç¤ºpayloadå†…å®¹
                    const payloadInfo = {
                        'ç”¨æˆ·ID': payload.userId || 'æœªè®¾ç½®',
                        'ç”¨æˆ·ç±»å‹': payload.userType || 'æœªè®¾ç½®',
                        'è§’è‰²': payload.role || 'æœªè®¾ç½®',
                        'Tokenç±»å‹': payload.type || 'æœªè®¾ç½®',
                        'ç­¾å‘æ—¶é—´': payload.iat ? new Date(payload.iat * 1000).toLocaleString() : 'æœªè®¾ç½®',
                        'è¿‡æœŸæ—¶é—´': payload.exp ? new Date(payload.exp * 1000).toLocaleString() : 'æœªè®¾ç½®'
                    };
                    
                    let payloadText = 'JWT Payload è¯¦æƒ…:\n';
                    for (const [key, value] of Object.entries(payloadInfo)) {
                        payloadText += `${key}: ${value}\n`;
                    }
                    addCode(section, payloadText);
                    
                    // æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
                    const isExpired = isTokenExpired(payload);
                    if (isExpired) {
                        addStatus(section, 'error', 'âŒ Token å·²è¿‡æœŸ');
                    } else {
                        addStatus(section, 'success', 'âœ… Token æœªè¿‡æœŸ');
                    }
                    
                    // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
                    const hasAdminRole = payload.role === 'admin' || payload.role === 'super_admin';
                    if (hasAdminRole) {
                        addStatus(section, 'success', `âœ… å…·æœ‰ç®¡ç†å‘˜æƒé™: ${payload.role}`);
                    } else {
                        addStatus(section, 'error', `âŒ ä¸å…·æœ‰ç®¡ç†å‘˜æƒé™: ${payload.role || 'æœªè®¾ç½®'}`);
                    }
                    
                } else {
                    addStatus(section, 'error', 'âŒ JWT Token è§£æå¤±è´¥');
                }
                
            } catch (error) {
                addStatus(section, 'error', `âŒ JWT Token è§£æå¼‚å¸¸: ${error.message}`);
                addCode(section, `é”™è¯¯è¯¦æƒ…: ${error.stack}`);
            }
        }

        /**
         * æ£€æŸ¥æƒé™ç›¸å…³çš„API
         */
        function checkPermissionAPI() {
            const section = createSection('ğŸŒ æƒé™APIæ£€æŸ¥');
            
            const token = localStorage.getItem('token');
            if (!token) {
                addStatus(section, 'error', 'âŒ æ— æ³•æµ‹è¯•APIï¼šToken ä¸å­˜åœ¨');
                return;
            }
            
            addStatus(section, 'info', 'ğŸ”„ æ­£åœ¨æµ‹è¯•æƒé™API...');
            
            // æµ‹è¯•æƒé™æ£€æŸ¥API
            fetch('/api/auth/check-permission', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                addStatus(section, 'info', `ğŸ“¡ æƒé™æ£€æŸ¥APIå“åº”çŠ¶æ€: ${response.status}`);
                return response.json();
            })
            .then(data => {
                addStatus(section, 'success', 'âœ… æƒé™æ£€æŸ¥APIå“åº”æˆåŠŸ');
                addCode(section, `APIå“åº”æ•°æ®:\n${JSON.stringify(data, null, 2)}`);
            })
            .catch(error => {
                addStatus(section, 'error', `âŒ æƒé™æ£€æŸ¥APIè¯·æ±‚å¤±è´¥: ${error.message}`);
            });
            
            // æµ‹è¯•ç”¨æˆ·åˆ—è¡¨API
            fetch('/api/users', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                addStatus(section, 'info', `ğŸ“¡ ç”¨æˆ·åˆ—è¡¨APIå“åº”çŠ¶æ€: ${response.status}`);
                if (response.status === 200) {
                    addStatus(section, 'success', 'âœ… ç”¨æˆ·åˆ—è¡¨APIè®¿é—®æˆåŠŸ');
                } else if (response.status === 401) {
                    addStatus(section, 'error', 'âŒ ç”¨æˆ·åˆ—è¡¨API: æœªæˆæƒ (401)');
                } else if (response.status === 403) {
                    addStatus(section, 'error', 'âŒ ç”¨æˆ·åˆ—è¡¨API: æƒé™ä¸è¶³ (403)');
                } else {
                    addStatus(section, 'warning', `âš ï¸ ç”¨æˆ·åˆ—è¡¨API: å…¶ä»–é”™è¯¯ (${response.status})`);
                }
                return response.text();
            })
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    addCode(section, `ç”¨æˆ·åˆ—è¡¨APIå“åº”:\n${JSON.stringify(data, null, 2)}`);
                } catch {
                    addCode(section, `ç”¨æˆ·åˆ—è¡¨APIå“åº” (æ–‡æœ¬):\n${text}`);
                }
            })
            .catch(error => {
                addStatus(section, 'error', `âŒ ç”¨æˆ·åˆ—è¡¨APIè¯·æ±‚å¤±è´¥: ${error.message}`);
            });
        }

        /**
         * ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
         */
        function generateDiagnosisReport() {
            const section = createSection('ğŸ“Š è¯Šæ–­æŠ¥å‘Š');
            
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            let report = '=== æƒé™è¯Šæ–­æŠ¥å‘Š ===\n\n';
            report += `è¯Šæ–­æ—¶é—´: ${new Date().toLocaleString()}\n\n`;
            
            // åŸºç¡€æ£€æŸ¥
            report += '1. åŸºç¡€æ£€æŸ¥:\n';
            report += `   - Tokenå­˜åœ¨: ${token ? 'âœ… æ˜¯' : 'âŒ å¦'}\n`;
            report += `   - ç”¨æˆ·ä¿¡æ¯å­˜åœ¨: ${user ? 'âœ… æ˜¯' : 'âŒ å¦'}\n`;
            
            if (token) {
                try {
                    const payload = parseJWTToken(token);
                    if (payload) {
                        report += '\n2. Tokenä¿¡æ¯:\n';
                        report += `   - ç”¨æˆ·ID: ${payload.userId || 'æœªè®¾ç½®'}\n`;
                        report += `   - è§’è‰²: ${payload.role || 'æœªè®¾ç½®'}\n`;
                        report += `   - ç”¨æˆ·ç±»å‹: ${payload.userType || 'æœªè®¾ç½®'}\n`;
                        report += `   - è¿‡æœŸçŠ¶æ€: ${isTokenExpired(payload) ? 'âŒ å·²è¿‡æœŸ' : 'âœ… æœªè¿‡æœŸ'}\n`;
                        
                        const hasAdmin = payload.role === 'admin' || payload.role === 'super_admin';
                        report += `   - ç®¡ç†å‘˜æƒé™: ${hasAdmin ? 'âœ… æœ‰' : 'âŒ æ— '}\n`;
                    }
                } catch (error) {
                    report += '\n2. Tokenè§£æå¤±è´¥\n';
                }
            }
            
            if (user) {
                try {
                    const userObj = JSON.parse(user);
                    report += '\n3. ç”¨æˆ·ä¿¡æ¯:\n';
                    report += `   - æ‰‹æœºå·: ${userObj.phone || 'æœªè®¾ç½®'}\n`;
                    report += `   - é‚®ç®±: ${userObj.email || 'æœªè®¾ç½®'}\n`;
                    report += `   - è§’è‰²: ${userObj.role || 'æœªè®¾ç½®'}\n`;
                } catch (error) {
                    report += '\n3. ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥\n';
                }
            }
            
            report += '\n4. å»ºè®®æ“ä½œ:\n';
            if (!token) {
                report += '   - é‡æ–°ç™»å½•è·å–æœ‰æ•ˆtoken\n';
            } else {
                const payload = parseJWTToken(token);
                if (payload && isTokenExpired(payload)) {
                    report += '   - Tokenå·²è¿‡æœŸï¼Œéœ€è¦åˆ·æ–°æˆ–é‡æ–°ç™»å½•\n';
                }
                if (payload && payload.role !== 'admin' && payload.role !== 'super_admin') {
                    report += '   - å½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæ— æ³•è®¿é—®ç®¡ç†åŠŸèƒ½\n';
                }
            }
            
            addCode(section, report);
        }

        /**
         * è§£æJWT tokençš„payloadéƒ¨åˆ†
         * @param {string} token - JWT tokenå­—ç¬¦ä¸²
         * @returns {object|null} è§£æåçš„payloadå¯¹è±¡
         */
        function parseJWTToken(token) {
            try {
                // ç§»é™¤Bearerå‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const cleanToken = token.replace(/^Bearer\s+/i, '').trim();
                
                // åˆ†å‰²token
                const parts = cleanToken.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format');
                }
                
                // è§£ç payloadéƒ¨åˆ†
                const payload = parts[1];
                
                // Base64URLè§£ç 
                const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
                
                // è§£æJSON
                return JSON.parse(decoded);
            } catch (error) {
                console.error('JWTè§£æé”™è¯¯:', error);
                return null;
            }
        }

        /**
         * æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
         * @param {object} payload - JWT payloadå¯¹è±¡
         * @returns {boolean} æ˜¯å¦è¿‡æœŸ
         */
        function isTokenExpired(payload) {
            if (!payload || !payload.exp) {
                return true;
            }
            
            const currentTime = Math.floor(Date.now() / 1000);
            return payload.exp < currentTime;
        }

        /**
         * åˆ›å»ºè¯Šæ–­ç»“æœåŒºåŸŸ
         * @param {string} title - åŒºåŸŸæ ‡é¢˜
         * @returns {HTMLElement} åˆ›å»ºçš„åŒºåŸŸå…ƒç´ 
         */
        function createSection(title) {
            const resultsDiv = document.getElementById('results');
            const section = document.createElement('div');
            section.className = 'section';
            
            const titleElement = document.createElement('h3');
            titleElement.textContent = title;
            section.appendChild(titleElement);
            
            resultsDiv.appendChild(section);
            return section;
        }

        /**
         * æ·»åŠ çŠ¶æ€ä¿¡æ¯
         * @param {HTMLElement} section - ç›®æ ‡åŒºåŸŸ
         * @param {string} type - çŠ¶æ€ç±»å‹ (success, error, warning, info)
         * @param {string} message - çŠ¶æ€æ¶ˆæ¯
         */
        function addStatus(section, type, message) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            section.appendChild(statusDiv);
        }

        /**
         * æ·»åŠ ä»£ç å—
         * @param {HTMLElement} section - ç›®æ ‡åŒºåŸŸ
         * @param {string} code - ä»£ç å†…å®¹
         */
        function addCode(section, code) {
            const codeDiv = document.createElement('div');
            codeDiv.className = 'code';
            codeDiv.textContent = code;
            section.appendChild(codeDiv);
        }

        /**
         * æ¸…é™¤è¯Šæ–­ç»“æœ
         */
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', function() {
            console.log('æƒé™è¯Šæ–­å·¥å…·å·²åŠ è½½');
        });
    </script>
</body>
</html>